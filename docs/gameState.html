<!DOCTYPE html>  <html> <head>   <title>gameState.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="basicAI.html">                 basicAI.coffee               </a>                                           <a class="source" href="cards.html">                 cards.coffee               </a>                                           <a class="source" href="compileStrategies.html">                 compileStrategies.coffee               </a>                                           <a class="source" href="gameState.html">                 gameState.coffee               </a>                                           <a class="source" href="heuristics.html">                 heuristics.coffee               </a>                                           <a class="source" href="play.html">                 play.coffee               </a>                                           <a class="source" href="playWeb.html">                 playWeb.coffee               </a>                                           <a class="source" href="testSimulation.html">                 testSimulation.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               gameState.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This "indecisive import" pattern is messy but it gets the job done, and it's
explained at the bottom of this documentation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">c</span><span class="p">,</span><span class="nx">transferCard</span><span class="p">,</span><span class="nx">transferCardToTop</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./cards&#39;</span> <span class="k">if</span> <span class="nx">exports</span><span class="o">?</span>
<span class="p">{</span><span class="nx">BasicAI</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./basicAI&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>The PlayerState class</h2>

<p>A PlayerState stores the part of the game state
that is specific to each player, plus what AI is making the decisions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">PlayerState</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>At the start of the game, the State should
.initialize() each PlayerState, which assigns its AI and sets up its
starting state. Before then, it is an empty object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialize: </span><span class="nf">(ai, logFunc) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>These attributes of the PlayerState are okay for card effects and
AI strategies to refer to.</p>

<p>Often, you will want to find out something
about the player whose turn it is, who will appear as <code>state.current</code>.
For example, if you want to know how many actions the current player
has, you can look up <code>state.current.actions</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@actions = </span><span class="mi">1</span>
    <span class="vi">@buys = </span><span class="mi">1</span>
    <span class="vi">@coins = </span><span class="mi">0</span>
    <span class="vi">@potions = </span><span class="mi">0</span>
    <span class="vi">@mats = </span><span class="p">{</span>
      <span class="nv">pirateShip: </span><span class="mi">0</span>
      <span class="nv">nativeVillage: </span><span class="p">[]</span>
      <span class="nv">island: </span><span class="p">[]</span>
    <span class="p">}</span>
    <span class="vi">@setAsideByHaven = </span><span class="p">[]</span>
    <span class="vi">@chips = </span><span class="mi">0</span>
    <span class="vi">@hand = </span><span class="p">[]</span>
    <span class="vi">@discard = </span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>If you want to ask what's in a player's draw pile, be sure to only do
it to a <em>hypothetical</em> PlayerState that you retrieve with
<code>state.hypothetical(ai)</code>. Then the draw pile will contain a random
guess, as opposed to the actual hidden information.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@draw = </span><span class="p">[]</span>
    <span class="vi">@inPlay = </span><span class="p">[]</span>
    <span class="vi">@duration = </span><span class="p">[]</span>
    <span class="vi">@setAside = </span><span class="p">[]</span>
    <span class="vi">@gainedThisTurn = </span><span class="p">[]</span>
    <span class="vi">@moatProtected = </span><span class="kc">no</span>
    <span class="vi">@tacticians = </span><span class="mi">0</span>  <span class="c1"># number of Tacticians that will go to the duration area</span>
    <span class="vi">@mayReturnTreasury = </span><span class="kc">yes</span>
    <span class="vi">@turnsTaken = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>To stack various card effects, we'll have to keep track of the location
of the card we're playing and the card we're gaining. For example, if
you have two Feasts in hand and you Throne Room a Feast, you don't
trash <em>both</em> Feasts -- you trash one and then do nothing, based on the
fact that <em>that particular</em> Feast is already in the trash.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@playLocation = </span><span class="s1">&#39;inPlay&#39;</span>
    <span class="vi">@gainLocation = </span><span class="s1">&#39;discard&#39;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The <code>actionStack</code> is not a physical location for cards to be in; it's
a computational list of what actions are in play but not yet resolved.
This becomes particularly important with King's Courts.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@actionStack = </span><span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Set the properties passed in from the State.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@ai = </span><span class="nx">ai</span>
    <span class="vi">@logFunc = </span><span class="nx">logFunc</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>To start the game, the player starts with the 10 starting cards
in the discard pile, then shuffles them and draws 5.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>Informational methods</h3>

<p>The methods here ask about general properties of a player's deck,
discard pile, and so on. A number of similar methods appear on the <code>State</code>
class defined below, which deal with information that is not so
player-specific, such as the cards in the supply.</p>

<p>As an example:
Most AI code will start with a reference to the State, called <code>state</code>.
If you want to check the number of cards in the current player's deck,
you would ask the <em>player object</em> <code>state.current</code>:</p>

<p>state.current.numCardsInDeck()</p>

<p>If you want to check how many piles are currently empty, you would ask
the <em>state object</em> itself:</p>

<p>state.numEmptyPiles()</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>getDeck()</code> returns all the cards in the player's deck, even those in
strange places such as the Island mat.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getDeck: </span><span class="nf">() -&gt;</span>
    <span class="nx">@draw</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@discard</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@hand</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@inPlay</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@duration</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@mats</span><span class="p">.</span><span class="nx">nativeVillage</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@mats</span><span class="p">.</span><span class="nx">island</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@setAsideByHaven</span>
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><code>getCurrentAction()</code> returns the action being resolved that is on the
top of the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCurrentAction: </span><span class="nf">() -&gt;</span>
    <span class="nx">@actionStack</span><span class="p">[</span><span class="nx">@actionStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><code>countInDeck(card)</code> counts the number of copies of a card in the deck.
The card may be specified either by name or as a card object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInDeck: </span><span class="nf">(card) -&gt;</span>
    <span class="nv">count = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card2</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="nx">card2</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">count</span><span class="o">++</span>
    <span class="nx">count</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><code>numCardsInDeck()</code> returns the size of the player's deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">numCardsInDeck: </span><span class="nf">() -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">().</span><span class="nx">length</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>countCardTypeInDeck(type)</code> counts the number of cards of a given type
in the deck. Curse is not a type for these purposes, it's a card.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countCardTypeInDeck: </span><span class="nf">(type) -&gt;</span>
    <span class="nv">typeChecker = </span><span class="s1">&#39;is&#39;</span><span class="o">+</span><span class="nx">type</span>
    <span class="nv">count = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">[</span><span class="nx">typeChecker</span><span class="p">]</span>
        <span class="nx">count</span><span class="o">++</span>
    <span class="nx">count</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><code>getVP()</code> returns the number of VP the player would have if the game
ended now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getVP: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">total = </span><span class="nx">@chips</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="nx">total</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getVP</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nx">total</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><code>getTotalMoney()</code> adds up the total money in the player's deck,
including <em>all</em> cards that provide a constant number of +$, not just
Treasure.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getTotalMoney: </span><span class="nf">() -&gt;</span>
    <span class="nv">total = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="nx">total</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">coins</span>
    <span class="nx">total</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><code>getAvailableMoney()</code> counts the money the player might have upon playing
all treasure in hand. Banks, Ventures, and such are counted inaccurately
so far.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getAvailableMoney: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTreasureInHand</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>getTreasureInHand()</code> adds up the value of the treasure in the player's
hand. Banks and Ventures and such will be inaccurate.</p>

<p>A <code>getMoneyInHand(state)</code> method that counted playable action cards would
be great, but I'm skipping it for now because it's difficult to get right.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getTreasureInHand: </span><span class="nf">() -&gt;</span>
    <span class="nv">total = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">hand</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nx">total</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">coins</span>
    <span class="nx">total</span>
  
  <span class="nv">countPlayableTerminals: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">@actions</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">@actions</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="p">(</span><span class="nx">card</span><span class="p">.</span><span class="nx">getActions</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">hand</span><span class="p">).</span><span class="nx">reduce</span> <span class="nf">(s,t) -&gt;</span> <span class="nx">s</span> <span class="o">+</span> <span class="nx">t</span><span class="p">)</span>
    <span class="k">else</span> <span class="mi">0</span>
    
   </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><code>countInHand(card)</code> counts the number of copies of a card in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInHand: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">countStr</span><span class="p">(</span><span class="nx">@hand</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><code>countInDiscard(card)</code> counts the number of copies of a card in the discard
pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInDiscard: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">countStr</span><span class="p">(</span><span class="nx">@discard</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><code>countInPlay(card)</code>
counts the number of copies of a card in play. Don't use this
for evaluating effects that stack, because you may also need
to take Throne Rooms and King's Courts into account.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInPlay: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">countStr</span><span class="p">(</span><span class="nx">@inPlay</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><code>numActionCardsInDeck()</code> is the number of action cards in the player's
entire deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">numActionCardsInDeck: </span><span class="nf">() -&gt;</span>
    <span class="nv">count = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nx">count</span>
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><code>getActionDensity()</code> returns a fractional value, between 0.0 and 1.0,
representing the proportion of actions in the deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getActionDensity: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">numActionCardsInDeck</span><span class="p">()</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">().</span><span class="nx">length</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><code>menagerieDraws()</code> is the number of cards the player would draw upon
playing a Menagerie: either 1 or 3.</p>

<p><em>TODO</em>: allow for a hypothetical version where it's okay to have another
Menagerie.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">menagerieDraws: </span><span class="nf">() -&gt;</span>
    <span class="nv">seen = </span><span class="p">{}</span>
    <span class="nv">cardsToDraw = </span><span class="mi">3</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">if</span> <span class="nx">seen</span><span class="p">[</span><span class="nx">card</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">cardsToDraw = </span><span class="mi">1</span>
        <span class="k">break</span>
      <span class="nx">seen</span><span class="p">[</span><span class="nx">card</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">cardsToDraw</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><code>shantyTownDraws()</code> is the number of cards the player draws upon
playing a Shanty town: either 0 or 2.</p>

<p>Set <code>hypothetical</code> to <code>true</code> if deciding whether to play a Shanty Town
(because it won't be in your hand anymore when you do).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shantyTownDraws: </span><span class="nf">(hypothetical = false) -&gt;</span>
    <span class="nv">cardsToDraw = </span><span class="mi">2</span>
    <span class="nv">skippedShanty = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="k">if</span> <span class="nx">hypothetical</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">skippedShanty</span>
          <span class="nv">skippedShanty = </span><span class="kc">true</span>
        <span class="k">else</span>
          <span class="nv">cardsToDraw = </span><span class="mi">0</span>
          <span class="k">break</span>
    <span class="nx">cardsToDraw</span>
  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><code>actionBalance()</code> is a complex method meant to be used by AIs in
deciding whether they want +actions or +cards, for example.</p>

<p>If the actionBalance is
less than 0, you want +actions, because otherwise you will have dead
action cards in hand or risk drawing them dead. If it is greater than
0, you want +cards, because you have a surplus of actions and need
action cards to spend them on.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">actionBalance: </span><span class="nf">() -&gt;</span>
    <span class="nv">balance = </span><span class="nx">@actions</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">balance</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">actions</span>
        <span class="nx">balance</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Estimate the risk of drawing an action card dead.</p>

<p><em>TODO</em>: do something better when there are variable card-drawers.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">actions</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="nx">balance</span> <span class="o">-=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">cards</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActionDensity</span><span class="p">()</span>
    <span class="nx">balance</span>
  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>What is the trashing power of this hand?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">trashingInHand: </span><span class="nf">() -&gt;</span>
    <span class="nv">trash = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">hand</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Count actions that simply trash a constant number of cards from hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">trash</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">trash</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Add other trashers, including the trash-on-gain power of Watchtower.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Steward</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Trading Post&#39;</span><span class="p">]</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">4</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Chapel</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Masquerade</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Ambassador</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Watchtower</span>
    <span class="k">return</span> <span class="nx">trash</span>
  
  <span class="nv">numUniqueCardsInPlay: </span><span class="nf">() -&gt;</span>
    <span class="nv">unique = </span><span class="p">[]</span>
    <span class="nv">cards = </span><span class="nx">@inPlay</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@duration</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">cards</span>
      <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">unique</span>
        <span class="nx">unique</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">unique</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>Methods that modify the PlayerState</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawCards: </span><span class="nf">(nCards) -&gt;</span>
    <span class="nv">drawn = </span><span class="k">this</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">nCards</span><span class="p">)</span>
    <span class="vi">@hand = </span><span class="nx">@hand</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@ai} draws #{drawn.length} cards (#{drawn}).&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">drawn</span>

  <span class="nv">discardFromDeck: </span><span class="nf">(nCards) -&gt;</span>
    <span class="nv">drawn = </span><span class="k">this</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">nCards</span><span class="p">)</span>
    <span class="vi">@discard = </span><span class="nx">@discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@ai} draws and discards #{drawn.length} cards (#{drawn}).&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">drawn</span>
  </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p><code>getCardsFromDeck</code> is a sub-method of many things that need to happen
with the game. It takes <code>nCards</code> cards off the deck, and then
<em>returns</em> them so you can do something with them.</p>

<p>Code that calls <code>getCardsFromDeck</code>
is responsible for making sure the cards aren't just "dropped on the
floor" after that, so to speak.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCardsFromDeck: </span><span class="nf">(nCards) -&gt;</span>
    <span class="k">if</span> <span class="nx">@draw</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">nCards</span>
      <span class="nv">diff = </span><span class="nx">nCards</span> <span class="o">-</span> <span class="nx">@draw</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">drawn = </span><span class="nx">@draw</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="vi">@draw = </span><span class="p">[]</span>
      <span class="k">if</span> <span class="nx">@discard</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">diff</span><span class="p">))</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">drawn</span>
        
    <span class="k">else</span>
      <span class="nv">drawn = </span><span class="nx">@draw</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nCards</span><span class="p">]</span>
      <span class="vi">@draw = </span><span class="nx">@draw</span><span class="p">[</span><span class="nx">nCards</span><span class="p">...]</span>
      <span class="k">return</span> <span class="nx">drawn</span>
  
  <span class="nv">doDiscard: </span><span class="nf">(card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{@ai} has no #{card} to discard&quot;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@ai} discards #{card}.&quot;</span><span class="p">)</span>
    <span class="nx">@hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">@discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
  
  <span class="nv">doTrash: </span><span class="nf">(card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{@ai} has no #{card} to trash&quot;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@ai} trashes #{card}.&quot;</span><span class="p">)</span>
    <span class="nx">@hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
  
  <span class="nv">doPutOnDeck: </span><span class="nf">(card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{@ai} has no #{card} to put on deck.&quot;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@ai} puts #{card} on deck.&quot;</span><span class="p">)</span>
    <span class="nx">@hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">@draw</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
  
  <span class="nv">shuffle: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;(#{@ai} shuffles.)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@draw</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Shuffling while there are cards left to draw&quot;</span><span class="p">)</span>
    <span class="nx">shuffle</span><span class="p">(</span><span class="nx">@discard</span><span class="p">)</span>
    <span class="vi">@draw = </span><span class="nx">@discard</span>
    <span class="vi">@discard = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>TODO: add an AI decision for Stashes</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Most PlayerStates are created by copying an existing one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">copy: </span><span class="nf">() -&gt;</span>
    <span class="nv">other = </span><span class="k">new</span> <span class="nx">PlayerState</span><span class="p">()</span>
    <span class="nv">other.actions = </span><span class="nx">@actions</span>
    <span class="nv">other.buys = </span><span class="nx">@buys</span>
    <span class="nv">other.coins = </span><span class="nx">@coins</span>
    <span class="nv">other.potions = </span><span class="nx">@potions</span>
    <span class="nv">other.setAsideByHaven = </span><span class="nx">@setAsideByHaven</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.mats = </span><span class="p">{}</span>
    <span class="nv">other.mats.pirateShip = </span><span class="nx">@mats</span><span class="p">.</span><span class="nx">pirateShip</span>
    <span class="nv">other.mats.nativeVillage = </span><span class="nx">@mats</span><span class="p">.</span><span class="nx">nativeVillage</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.mats.island = </span><span class="nx">@mats</span><span class="p">.</span><span class="nx">island</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.chips = </span><span class="nx">@chips</span>
    <span class="nv">other.hand = </span><span class="nx">@hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.draw = </span><span class="nx">@draw</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.discard = </span><span class="nx">@discard</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.inPlay = </span><span class="nx">@inPlay</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.duration = </span><span class="nx">@duration</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.setAside = </span><span class="nx">@setAside</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.moatProtected = </span><span class="nx">@moatProtected</span>
    <span class="nv">other.gainedThisTurn = </span><span class="nx">@gainedThisTurn</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.mayReturnTreasury = </span><span class="nx">@mayReturnTreasury</span>
    <span class="nv">other.playLocation = </span><span class="nx">@playLocation</span>
    <span class="nv">other.gainLocation = </span><span class="nx">@gainLocation</span>
    <span class="nv">other.actionStack = </span><span class="nx">@actionStack</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.tacticians = </span><span class="nx">@tacticians</span>
    <span class="nv">other.ai = </span><span class="nx">@ai</span>
    <span class="nv">other.logFunc = </span><span class="nx">@logFunc</span>
    <span class="nv">other.turnsTaken = </span><span class="nx">@turnsTaken</span>
    <span class="nx">other</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Games can provide output using the <code>log</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">log: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="o">?</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">console</span><span class="o">?</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h2>The State class</h2>

<p>A State instance stores the complete state of the game at a point in time.</p>

<p>Many operations will mutate the state, for the sake of efficiency.
Any AI that evaluates different possible decisions must make a copy of
that state with less information in it, anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">State</span>
  <span class="nv">basicSupply: </span><span class="p">[</span><span class="s1">&#39;Curse&#39;</span><span class="p">,</span> <span class="s1">&#39;Copper&#39;</span><span class="p">,</span> <span class="s1">&#39;Silver&#39;</span><span class="p">,</span> <span class="s1">&#39;Gold&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Estate&#39;</span><span class="p">,</span> <span class="s1">&#39;Duchy&#39;</span><span class="p">,</span> <span class="s1">&#39;Province&#39;</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>AIs can get at the <code>c</code> object that stores information about cards
by looking up <code>state.cardInfo</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cardInfo: </span><span class="nx">c</span>
  </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Set up the state at the start of the game. Takes these arguments:</p>

<ul>
<li><code>ais</code>: a list of AI objects that will make the decisions, one per player.
This sets the number of players in the game.</li>
<li><code>tableau</code>: the list of non-basic cards in the supply. Colony, Platinum,
and Potion have to be listed explicitly.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialize: </span><span class="nf">(ais, tableau, logFunc) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nv">logFunc = </span><span class="nx">logFunc</span>
    <span class="vi">@players = </span><span class="p">(</span><span class="k">new</span> <span class="nx">PlayerState</span><span class="p">().</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">ai</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="p">)</span> <span class="k">for</span> <span class="nx">ai</span> <span class="k">in</span> <span class="nx">ais</span><span class="p">)</span>
    <span class="vi">@nPlayers = </span><span class="nx">@players</span><span class="p">.</span><span class="nx">length</span>
    <span class="vi">@current = </span><span class="nx">@players</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="vi">@supply = </span><span class="k">this</span><span class="p">.</span><span class="nx">makeSupply</span><span class="p">(</span><span class="nx">tableau</span><span class="p">)</span>
    <span class="vi">@prizes = </span><span class="p">[</span><span class="nx">c</span><span class="p">[</span><span class="s2">&quot;Bag of Gold&quot;</span><span class="p">],</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Diadem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Followers</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Princess</span><span class="p">,</span> <span class="nx">c</span><span class="p">[</span><span class="s2">&quot;Trusty Steed&quot;</span><span class="p">]]</span>
    <span class="vi">@tradeRouteMat = </span><span class="p">[]</span>
    <span class="vi">@tradeRouteValue = </span><span class="mi">0</span>

    <span class="vi">@bridges = </span><span class="mi">0</span>
    <span class="vi">@quarries = </span><span class="mi">0</span>
    <span class="vi">@copperValue = </span><span class="mi">1</span>
    <span class="vi">@phase = </span><span class="s1">&#39;start&#39;</span>
    <span class="vi">@extraturn = </span><span class="kc">false</span>
    
    <span class="vi">@cache = </span><span class="p">{}</span>
    
    </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The <code>depth</code> indicates how deep into hypothetical situations we are. A depth of 0
indicates the state of the actual game.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@depth = </span><span class="mi">0</span>
    <span class="k">return</span> <span class="k">this</span>
  </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Given the tableau (the set of non-basic cards in play), construct the
appropriate supply for the number of players.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeSupply: </span><span class="nf">(tableau) -&gt;</span>
    <span class="nv">allCards = </span><span class="k">this</span><span class="p">.</span><span class="nx">basicSupply</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">tableau</span><span class="p">)</span>
    <span class="nv">supply = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">allCards</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">?</span> <span class="nx">card</span>
      <span class="nx">supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">startingSupply</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">supply</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h3>Informational methods</h3>

<p>These methods are referred to by some card effects, but can also be useful
in crafting a strategy.</p>

<p><code>emptyPiles()</code> determines which supply piles are empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">emptyPiles: </span><span class="nf">() -&gt;</span>
    <span class="nv">piles = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@supply</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nx">piles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">piles</span>
  </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p><code>numEmptyPiles()</code> simply returns the number of empty piles.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">numEmptyPiles: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emptyPiles</span><span class="p">().</span><span class="nx">length</span>
  </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p><code>gameIsOver()</code> returns whether the game is over.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gameIsOver: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>The game can only end after a player has taken a full turn. Check that
by making sure the phase is <code>'start'</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@phase</span> <span class="o">!=</span> <span class="s1">&#39;start&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Check all the conditions in which empty piles can end the game.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">emptyPiles = </span><span class="k">this</span><span class="p">.</span><span class="nx">emptyPiles</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">emptyPiles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">totalPilesToEndGame</span><span class="p">()</span> <span class="o">\</span>
        <span class="o">or</span> <span class="p">(</span><span class="nx">@nPlayers</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">and</span> <span class="nx">emptyPiles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">\</span>
        <span class="o">or</span> <span class="s1">&#39;Province&#39;</span> <span class="k">in</span> <span class="nx">emptyPiles</span> <span class="o">\</span>
        <span class="o">or</span> <span class="s1">&#39;Colony&#39;</span> <span class="k">in</span> <span class="nx">emptyPiles</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Empty piles: #{emptyPiles}&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">playerName</span><span class="p">,</span> <span class="nx">vp</span><span class="p">,</span> <span class="nx">turns</span><span class="p">]</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getFinalStatus</span><span class="p">()</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{playerName} took #{turns} turns and scored #{vp} points.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p><code>getFinalStatus()</code> is a useful thing to call when <code>gameIsOver()</code> is true.
It returns a list of triples of [player name, score, turns taken].</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getFinalStatus: </span><span class="nf">() -&gt;</span>
    <span class="p">([</span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">player</span><span class="p">.</span><span class="nx">getVP</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">player</span><span class="p">.</span><span class="nx">turnsTaken</span><span class="p">]</span> <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">@players</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p><code>getWinners()</code> returns a list (usually of length 1) of the names of players
that won the game, or would win if it were over now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getWinners: </span><span class="nf">() -&gt;</span>
    <span class="nv">scores = </span><span class="k">this</span><span class="p">.</span><span class="nx">getFinalStatus</span><span class="p">()</span>
    <span class="nv">best = </span><span class="p">[]</span>
    <span class="nv">bestScore = </span><span class="o">-</span><span class="kc">Infinity</span>
    
    <span class="k">for</span> <span class="p">[</span><span class="nx">player</span><span class="p">,</span> <span class="nx">score</span><span class="p">,</span> <span class="nx">turns</span><span class="p">]</span> <span class="k">in</span> <span class="nx">scores</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Modify the score by subtracting a fraction of turnsTaken.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">modScore = </span><span class="nx">score</span> <span class="o">-</span> <span class="nx">turns</span><span class="err">/100</span>

      <span class="k">if</span> <span class="nx">modScore</span> <span class="o">==</span> <span class="nx">bestScore</span>
        <span class="nx">best</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">modScore</span> <span class="o">&gt;</span> <span class="nx">bestScore</span>
        <span class="nv">best = </span><span class="p">[</span><span class="nx">player</span><span class="p">]</span>
        <span class="nv">bestScore = </span><span class="nx">modScore</span>
    <span class="nx">best</span>
  </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p><code>countInSupply()</code> returns the number of copies of a card that remain
in the supply. It can take in either a card object or card name.</p>

<p>If the card has never been in the supply, it returns 0,
so it is safe to refer to <code>state.countInSupply('Colony')</code> even in
a non-Colony game. This does not count as an empty pile, of course.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInSupply: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span>
  </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p><code>totalPilesToEndGame()</code> returns the number of empty piles that triggers
the end of the game, which is almost always 3.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">totalPilesToEndGame: </span><span class="nf">() -&gt;</span>
    <span class="k">switch</span> <span class="nx">@nPlayers</span>
      <span class="k">when</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="k">then</span> <span class="mi">3</span>
      <span class="k">else</span> <span class="mi">4</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>As a useful heuristic, <code>gainsToEndGame()</code> returns the minimum number of
buys/gains that would have to be used by an opponent who is determined to
end the game. A low number means the game is probably ending soon.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainsToEndGame: </span><span class="nf">() -&gt;</span>
    <span class="k">if</span> <span class="nx">@cache</span><span class="p">.</span><span class="nx">gainsToEndGame</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">@cache</span><span class="p">.</span><span class="nx">gainsToEndGame</span>
    <span class="nv">counts = </span><span class="p">(</span><span class="nx">count</span> <span class="k">for</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">count</span> <span class="k">of</span> <span class="nx">@supply</span><span class="p">)</span>
    <span class="nx">numericSort</span><span class="p">(</span><span class="nx">counts</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>First, add up the smallest 3 (or 4) piles.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">piles = </span><span class="k">this</span><span class="p">.</span><span class="nx">totalPilesToEndGame</span><span class="p">()</span>
    <span class="nv">minimum = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">count</span> <span class="k">in</span> <span class="nx">counts</span><span class="p">[...</span><span class="nx">piles</span><span class="p">]</span>
      <span class="nx">minimum</span> <span class="o">+=</span> <span class="nx">count</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Then compare this to the number of Provinces or possibly Colonies
remaining, and see which one is smallest.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">minimum = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minimum</span><span class="p">,</span> <span class="nx">@supply</span><span class="p">[</span><span class="s1">&#39;Province&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">@supply</span><span class="p">[</span><span class="s1">&#39;Colony&#39;</span><span class="p">]</span><span class="o">?</span>
      <span class="nv">minimum = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minimum</span><span class="p">,</span> <span class="nx">@supply</span><span class="p">[</span><span class="s1">&#39;Colony&#39;</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Cache the result; apparently it's expensive to compute.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@cache.gainsToEndGame = </span><span class="nx">minimum</span>
    <span class="nx">minimum</span>
  </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p><code>smugglerChoices</code> determines the set of cards that could be gained with a
Smuggler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">smugglerChoices: </span><span class="nf">() -&gt;</span>
    <span class="nv">choices = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span>
    <span class="nv">prevPlayer = </span><span class="nx">@players</span><span class="p">[</span><span class="nx">@nPlayers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">prevPlayer</span><span class="p">.</span><span class="nx">gainedThisTurn</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">potions</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;=</span> <span class="mi">6</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">choices</span>
  </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h3>Playing a turn</h3>

<p><code>doPlay</code> performs the next step of the game, which is a particular phase
of a particular player's turn. If the phase is...</p>

<ul>
<li>'start': resolve duration effects, then go to action phase</li>
<li>'action': play and resolve some number of actions, then go to
treasure phase</li>
<li>'treasure': play and resolve some number of treasures, then go to
buy phase</li>
<li>'buy': buy some number of cards, then go to cleanup phase</li>
<li>'cleanup': resolve cleanup effects, discard everything, draw 5 cards,
and go to the start phase of the next player's turn.</li>
</ul>

<p>To play the entire game, iterate <code>doPlay()</code> until <code>gameIsOver()</code>. Putting
this in a single loop would be a bad idea because it would make Web
browsers freeze up. Browser-facing code should return control after each
call to <code>doPlay()</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doPlay: </span><span class="nf">() -&gt;</span>  
    <span class="k">switch</span> <span class="nx">@phase</span>
      <span class="k">when</span> <span class="s1">&#39;start&#39;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">@extraturn</span>
          <span class="nx">@current</span><span class="p">.</span><span class="nx">turnsTaken</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n== #{@current.ai}&#39;s turn #{@current.turnsTaken} ==&quot;</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">doDurationPhase</span><span class="p">()</span>
          <span class="vi">@phase = </span><span class="s1">&#39;action&#39;</span>
        <span class="k">else</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n== #{@current.ai}&#39;s turn #{@current.turnsTaken}+ ==&quot;</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">doDurationPhase</span><span class="p">()</span>
          <span class="vi">@phase = </span><span class="s1">&#39;action&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;action&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doActionPhase</span><span class="p">()</span>
        <span class="vi">@phase = </span><span class="s1">&#39;treasure&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;treasure&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doTreasurePhase</span><span class="p">()</span>
        <span class="vi">@phase = </span><span class="s1">&#39;buy&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;buy&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doBuyPhase</span><span class="p">()</span>
        <span class="vi">@phase = </span><span class="s1">&#39;cleanup&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;cleanup&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doCleanupPhase</span><span class="p">()</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">@extraturn</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">rotatePlayer</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="vi">@phase = </span><span class="s1">&#39;start&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p><code>@current.duration</code> contains all cards that are in play with duration
effects. At the start of the turn, check all of these cards and run their
<code>onDuration</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doDurationPhase: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Clear out the list of cards gained. (We clear it here because this
information is actually used by Smugglers.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.gainedThisTurn = </span><span class="p">[]</span>

    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="k">this</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span>
      <span class="nv">estimatedBuys = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">pessimisticCardsGained</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} plans to buy #{estimatedBuys}.&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>iterate backwards because cards might move</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">card = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} resolves the duration effect of #{card}.&quot;</span><span class="p">)</span>
      <span class="nx">card</span><span class="p">.</span><span class="nx">onDuration</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Perform the action phase. Ask the AI repeatedly which action to play,
until there are no more action cards to play or there are no
actions remaining to play them with, or the AI chooses <code>null</code>, indicating
that it doesn't want to play an action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doActionPhase: </span><span class="nf">() -&gt;</span>
    <span class="k">while</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">validActions = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Determine the set of unique actions that may be played.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span> <span class="o">and</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">validActions</span>
          <span class="nx">validActions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Ask the AI for its choice.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">action = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseAction</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validActions</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Remove the action from the hand and put it in the play area.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">action</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} chose an invalid action.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">playAction</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>The current player plays an action from the hand, and performs the effect
of the action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">playAction: </span><span class="nf">(action) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} plays #{action}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Subtract 1 from the action count and perform the action.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    <span class="vi">@current.playLocation = </span><span class="s1">&#39;inPlay&#39;</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resolveAction</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Another event that causes actions to be played, such as Throne Room,
should skip straight to <code>resolveAction</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveAction: </span><span class="nf">(action) -&gt;</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">actionStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    <span class="nx">action</span><span class="p">.</span><span class="nx">onPlay</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">actionStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>The "treasure phase" is a concept introduced in Prosperity. After playing
actions, you play any number of treasures in some order. This loop
repeats until the AI chooses <code>null</code>, either because there are no treasures
left to play or because it does not want to play any more treasures.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doTreasurePhase: </span><span class="nf">() -&gt;</span>
    <span class="nx">loop</span>
      <span class="nv">validTreasures = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Determine the set of unique treasures that may be played.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span> <span class="o">and</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">validTreasures</span>
          <span class="nx">validTreasures</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Ask the AI for its choice.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">treasure = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseTreasure</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validTreasures</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">treasure</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} plays #{treasure}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Remove the treasure from the hand and put it in the play area.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">treasure</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} chose an invalid treasure&quot;</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">playTreasure</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
  
  <span class="nv">playTreasure: </span><span class="nf">(treasure) -&gt;</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
    <span class="vi">@current.playLocation = </span><span class="s1">&#39;inPlay&#39;</span>
    <span class="nx">treasure</span><span class="p">.</span><span class="nx">onPlay</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Ask the AI what to buy. Repeat until the player has no buys left or
the AI chooses to buy nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doBuyPhase: </span><span class="nf">() -&gt;</span>
    <span class="k">while</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">buys</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">buyable = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">cardname</span><span class="p">,</span> <span class="nx">count</span> <span class="k">of</span> <span class="nx">@supply</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Because the supply must reference cards by their names, we use
<code>c[cardname]</code> to get the actual object for the card.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardname</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Determine whether each card can be bought in the current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">mayBeBought</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">and</span> <span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="p">[</span><span class="nx">coinCost</span><span class="p">,</span> <span class="nx">potionCost</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">coinCost</span> <span class="o">&lt;=</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">and</span> <span class="nx">potionCost</span> <span class="o">&lt;=</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">potions</span>
            <span class="nx">buyable</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Ask the AI for its choice.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Coins: #{@current.coins}, Potions: #{@current.potions}, Buys: #{@current.buys}&quot;</span><span class="p">)</span>
      <span class="nv">choice = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">buyable</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} buys #{choice}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Update money and buys.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">[</span><span class="nx">coinCost</span><span class="p">,</span> <span class="nx">potionCost</span><span class="p">]</span> <span class="o">=</span> <span class="nx">choice</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">-=</span> <span class="nx">coinCost</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">potions</span> <span class="o">-=</span> <span class="nx">potionCost</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">buys</span> <span class="o">-=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Gain the card and deal with the effects.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">@current</span><span class="p">,</span> <span class="nx">choice</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">choice</span><span class="p">.</span><span class="nx">onBuy</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Handle cards such as Talisman that respond to cards being bought.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">cardInPlay = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="nx">cardInPlay</span><span class="p">.</span><span class="nx">buyInPlayEffect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Gain victory for each Goons in play.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">goonses = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">countInPlay</span><span class="p">(</span><span class="s1">&#39;Goons&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">goonses</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...gaining #{goonses} VP.&quot;</span><span class="p">)</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">chips</span> <span class="o">+=</span> <span class="nx">goonses</span>
  </pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Handle all the things that happen at the end of the turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doCleanupPhase: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Clean up Walled Villages first</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">actionCardsInPlay = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">actionCardsInPlay</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nx">actionCardsInPlay</span> <span class="o">&lt;=</span> <span class="mi">2</span>  
      <span class="k">while</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Walled Village&#39;</span><span class="p">]</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span>
        <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Walled Village&#39;</span><span class="p">],</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">,</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} returns a Walled Village to the top of the deck.&quot;</span><span class="p">)</span>

    <span class="vi">@extraturn = </span><span class="o">not</span> <span class="nx">@extraturn</span> <span class="o">and</span> <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Outpost&#39;</span><span class="p">]</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Discard old duration cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.discard = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span>
    <span class="vi">@current.duration = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>If there are cards set aside at this point, it probably means something
went wrong in performing an action. But clean them up anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">([</span><span class="s2">&quot;Cards were set aside at the end of turn&quot;</span><span class="p">,</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">])</span>
      <span class="vi">@current.discard = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">setAside</span>
      <span class="vi">@current.setAside = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Clean up cards in play.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="vi">@current.inPlay = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Put duration cards by default in the duration area, and other cards
in play in the discard pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isDuration</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Handle effects of cleaning up the card, which may involve moving it
somewhere else.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">card</span><span class="p">.</span><span class="nx">onCleanup</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Discard the remaining cards in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.discard = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
    <span class="vi">@current.hand = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Reset things for the next turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.actions = </span><span class="mi">1</span>
    <span class="vi">@current.buys = </span><span class="mi">1</span>
    <span class="vi">@current.coins = </span><span class="mi">0</span>
    <span class="vi">@current.potions = </span><span class="mi">0</span>
    <span class="vi">@current.tacticians = </span><span class="mi">0</span>
    <span class="vi">@current.mayReturnTreasury = </span><span class="kc">yes</span>
    <span class="vi">@copperValue = </span><span class="mi">1</span>
    <span class="vi">@bridges = </span><span class="mi">0</span>
    <span class="vi">@quarries = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Announce extra turn</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@extraturn</span>       
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} takes an extra turn from Outpost.&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Finally, draw the next hand of three/five cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Outpost</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>The player list is implemented so that the current player is always first
in the list; the list rotates after every turn.</p>

<p>For convenience, the attribute <code>@current</code> always points to the current
player.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rotatePlayer: </span><span class="nf">() -&gt;</span>
    <span class="vi">@players = </span><span class="nx">@players</span><span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">@nPlayers</span><span class="p">].</span><span class="nx">concat</span> <span class="p">[</span><span class="nx">@players</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="vi">@current = </span><span class="nx">@players</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="vi">@phase = </span><span class="s1">&#39;start&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <h3>Small-scale effects</h3>

<p><code>gainCard</code> performs the effects of a player gaining a card.</p>

<p>This is one of many events that affects a particular player, and
also has some effect on the overall state (in that the supply is
decreased). In this function and others like it, the <code>player</code> argument
is the appropriate PlayerState object to affect. This must, of course,
be one of the objects in the <code>@players</code> array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainCard: </span><span class="nf">(player, card, gainLocation=&#39;discard&#39;, suppressMessage=false) -&gt;</span>
    <span class="k">delete</span> <span class="nx">@cache</span><span class="p">.</span><span class="nx">gainsToEndGame</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@prizes</span> <span class="o">or</span> <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Keep track of the card gained, for Smugglers.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">player</span> <span class="o">is</span> <span class="nx">@current</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">gainedThisTurn</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p><code>suppressMessage</code> is true when this happens as the direct result of a
buy. Nobody wants to read "X buys Y. X gains Y." all the time.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">suppressMessage</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} gains #{card}.&quot;</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Determine what list the card is being gained in, and add it to the
front of that list; also, have the PlayerState remember it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">player.gainLocation = </span><span class="nx">gainLocation</span>
      <span class="nv">location = </span><span class="nx">player</span><span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">gainLocation</span><span class="p">]</span>
      <span class="nx">location</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Remove the card from the supply or the prize list, as appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@prizes</span>
        <span class="nx">@prizes</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
      
      <span class="k">if</span> <span class="nx">@supply</span><span class="p">[</span><span class="s2">&quot;Trade Route&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span> <span class="o">and</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@tradeRouteMat</span>
        <span class="nx">@tradeRouteMat</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="nx">@tradeRouteValue</span> <span class="o">+=</span> <span class="mi">1</span>
      </pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Handle cards such as Royal Seal that respond to gains while they are
in play.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">cardInPlay = </span><span class="nx">player</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="nx">cardInPlay</span><span class="p">.</span><span class="nx">gainInPlayEffect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Handle cards such as Watchtower that react to gains as a Reaction card.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">reactCard = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">reactCard</span><span class="p">.</span><span class="nx">isReaction</span>
          <span class="nx">reactCard</span><span class="p">.</span><span class="nx">reactToGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;There is no #{card} to gain.&quot;</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Effects of an action could cause players to reveal their hand.
So far, nothing happens as a result, but in the future, AIs might
be able to take advantage of the information.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">revealHand: </span><span class="nf">(player) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} reveals the hand (#{player.hand}).&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p><code>drawCards</code> causes the player to draw <code>num</code> cards.</p>

<p>This currently passes through directly to the PlayerState, without
passing any information from the global state.
An improved version would pass the state in case the player shuffles,
and has Stash in the deck, and wants to use information from the state
to decide where to put the Stash.</p>

<p>The drawn cards will be returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawCards: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p><code>discardFromDeck</code> puts <em>num</em> cards from the top of the deck directly
in the discard pile. It returns the set of cards, for the benefit of
actions that do something based on which cards were discarded.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">discardFromDeck: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">discardFromDeck</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p><code>getCardsFromDeck</code> is superficially similar to <code>drawCards</code>, but it does
not put the cards into the hand. Any code that calls it needs to determine
what happens to those cards (otherwise they'll be trashed!) This is useful
for effects that say "draw <em>n</em> cards, do something based on them, and
discard them".</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCardsFromDeck: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p><code>allowDiscard</code> allows a player to discard 0 through <code>num</code> cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allowDiscard: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">discarded = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>In <code>allowDiscard</code>, valid discards are the entire hand, plus <code>null</code>
to stop discarding.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">validDiscards = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">validDiscards</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseDiscard</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validDiscards</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">discarded</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="nx">discarded</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="nx">player</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">discarded</span>
  </pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p><code>requireDiscard</code> requires the player to discard exactly <code>num</code> cards,
except that it stops if the player has 0 cards in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">requireDiscard: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">discarded = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span>
      <span class="nv">validDiscards = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">discarded</span> <span class="k">if</span> <span class="nx">validDiscards</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseDiscard</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validDiscards</span><span class="p">)</span>
      <span class="nx">discarded</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="nx">player</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">discarded</span>
  </pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p><code>allowTrash</code> and <code>requireTrash</code> are similar to <code>allowDiscard</code> and
<code>requireDiscard</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allowTrash: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">trashed = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span>
      <span class="nv">valid = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">valid</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseTrash</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">valid</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">trashed</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="nx">trashed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="nx">player</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">trashed</span>
  
  <span class="nv">requireTrash: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">trashed = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span>
      <span class="nv">valid = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">trashed</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseTrash</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">valid</span><span class="p">)</span>
      <span class="nx">trashed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="nx">player</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">trashed</span>
  </pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p><code>gainOneOf</code> gives the player a choice of cards to gain. Include
<code>null</code> if gaining nothing is an option.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainOneOf: </span><span class="nf">(player, options, location=&#39;discard&#39;) -&gt;</span>
    <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">choice</span><span class="p">,</span> <span class="nx">location</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">choice</span>
  </pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p><code>attackOpponents</code> takes in a function of one argument, and applies
it to all players except the one whose turn it is.</p>

<p>The function should take in the PlayerState of the player to attack,
and alter it somehow. This function can also involve the global state:
it doesn't need to be passed in because it's already in scope in the place
where the action is defined. See <code>Militia</code> in <code>cards.coffee</code> for an
example.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attackOpponents: </span><span class="nf">(effect) -&gt;</span>
    <span class="k">for</span> <span class="nx">opp</span> <span class="k">in</span> <span class="nx">@players</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">attackPlayer</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">effect</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p><code>attackPlayer</code> does the work of attacking a particular player, including
handling their reactions to attacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attackPlayer: </span><span class="nf">(player, effect) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>The most straightforward reaction is Moat, which cancels the attack.
Set a flag on the PlayerState that indicates that the player has not
yet revealed a Moat.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">player.moatProtected = </span><span class="kc">no</span>
    </pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Iterate backwards, because we might be removing things from the list.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">card = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isReaction</span>
        <span class="nx">card</span><span class="p">.</span><span class="nx">reactToAttack</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>If the player has revealed a Moat, or has Lighthouse in the duration
area, the attack is averted. Otherwise, it happens.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">moatProtected</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} is protected by a Moat.&quot;</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Lighthouse</span> <span class="k">in</span> <span class="nx">player</span><span class="p">.</span><span class="nx">duration</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} is protected by the Lighthouse.&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">effect</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <h3>Bookkeeping</h3>

<p><code>copy()</code> makes a copy of this state that can be safely mutated
without affecting the original state.</p>

<p>Ideally, the AI would be passed a copy of the state, with unknown
information randomized, when it is asked to make a decision. This would
allow it to try simulating the effects of various plays without actually
breaking the game. But this isn't implemented yet, so make this a TODO.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">copy: </span><span class="nf">() -&gt;</span>
    <span class="nv">newSupply = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@supply</span>
      <span class="nx">newSupply</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    
    <span class="nv">newState = </span><span class="k">new</span> <span class="nx">State</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>If something overrode the log function, make sure that's preserved.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">newState.logFunc = </span><span class="nx">@logFunc</span>

    <span class="nv">newPlayers = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">@players</span>
      <span class="nv">playerCopy = </span><span class="nx">player</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nv">playerCopy.logFunc = </span><span class="nf">(obj) -&gt;</span>
      <span class="nx">newPlayers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">playerCopy</span><span class="p">)</span>
    
    <span class="nv">newState.players = </span><span class="nx">newPlayers</span>
    <span class="nv">newState.supply = </span><span class="nx">newSupply</span>
    <span class="nv">newState.current = </span><span class="nx">newPlayers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">newState.nPlayers = </span><span class="nx">@nPlayers</span>
    <span class="nv">newState.tradeRouteMat = </span><span class="nx">@tradeRouteMat</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">newState.tradeRouteValue = </span><span class="nx">@tradeRouteValue</span>
    <span class="nv">newState.bridges = </span><span class="nx">@bridges</span>
    <span class="nv">newState.quarries = </span><span class="nx">@quarries</span>
    <span class="nv">newState.copperValue = </span><span class="nx">@copperValue</span>
    <span class="nv">newState.phase = </span><span class="nx">@phase</span>
    <span class="nv">newState.cache = </span><span class="p">{}</span>
    <span class="nv">newState.prizes = </span><span class="nx">@prizes</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nx">newState</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p><code>hypothetical(ai)</code> returns a State and PlayerState that an AI can do
whatever it wants to without affecting the real state:</p>

<ul>
<li>Modifying the state will not affect the game (it is a copy, after all).</li>
<li>The hidden information in the state is randomized.</li>
<li>All the other AIs will be replaced by copies of the given AI.</li>
</ul>

<p>An AI that wants to test a hypothesis should do this:
  [state, my] = state.hypothetical(this)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hypothetical: </span><span class="nf">(ai) -&gt;</span>
    <span class="nv">state = </span><span class="k">this</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
    <span class="nv">state.depth = </span><span class="k">this</span><span class="p">.</span><span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">my = </span><span class="kc">null</span>
    <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span>
      <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span> <span class="o">isnt</span> <span class="nx">ai</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Leave the AI alone for now; something goes weirdly wrong otherwise.
Yes, this means we're technically reading their strategy.</p>

<p>We don't know what's in their hand or their deck, so shuffle them
together randomly, preserving the number of cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">handSize = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">combined = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="nx">shuffle</span><span class="p">(</span><span class="nx">combined</span><span class="p">)</span>
        <span class="nv">player.hand = </span><span class="nx">combined</span><span class="p">[...</span><span class="nx">handSize</span><span class="p">]</span>
        <span class="nv">player.draw = </span><span class="nx">combined</span><span class="p">[</span><span class="nx">handSize</span><span class="p">...]</span>
      <span class="k">else</span>
        <span class="nx">shuffle</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="nv">my = </span><span class="nx">player</span>

    <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">my</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Games can provide output using the <code>log</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">log: </span><span class="nf">(obj) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Only log things that actually happen.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@depth</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="o">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="k">else</span> 
        <span class="k">if</span> <span class="nx">console</span><span class="o">?</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>A warning has a similar effect to a log message, but indicates that
something has gone wrong with the gameplay.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">warn: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="nx">console</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;WARNING: &quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Define some possible tableaux to play the game with. None of these are
actually legal tableaux, but that gives strategies more room to play.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nv">tableaux = </span><span class="p">{</span>
  <span class="nv">moneyOnly: </span><span class="p">[]</span>
  <span class="nv">moneyOnlyColony: </span><span class="p">[</span><span class="s1">&#39;Platinum&#39;</span><span class="p">,</span> <span class="s1">&#39;Colony&#39;</span><span class="p">]</span>
  <span class="nv">all: </span><span class="nx">c</span><span class="p">.</span><span class="nx">allCards</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>How to remove something from a JavaScript array. Modifies the list and
returns the 0 or 1 removed elements.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Array</span><span class="p">.</span><span class="nv">prototype.remove = </span><span class="nf">(elt) -&gt;</span>
  <span class="nv">idx = </span><span class="k">this</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">elt</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Define the additional tableau of everything but Platinum/Colony.
If there's a better way to remove items from a JS array, I'd like to know
what it is.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">noColony = </span><span class="k">this</span><span class="p">.</span><span class="nx">tableaux</span><span class="p">.</span><span class="nx">all</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nx">noColony</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;Platinum&#39;</span><span class="p">)</span>
<span class="nx">noColony</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;Colony&#39;</span><span class="p">)</span>
<span class="k">this</span><span class="p">.</span><span class="nv">tableaux.noColony = </span><span class="nx">noColony</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <h2>Utility functions</h2>

<p>This customized clone function will not make unnecessary copies of
cards and AIs. However, it doesn't seem to work.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cloneDominionObject = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">obj</span><span class="o">?</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">isnt</span> <span class="s1">&#39;object&#39;</span>
    <span class="k">return</span> <span class="nx">obj</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">gainPriority</span><span class="o">?</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">costInCoins</span><span class="o">?</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">obj</span>
  <span class="nv">newInstance = </span><span class="k">new</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="nx">newInstance</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cloneDominionObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="nx">newInstance</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>General function to randomly shuffle a list.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">shuffle = </span><span class="nf">(v) -&gt;</span>
  <span class="nv">i = </span><span class="nx">v</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">while</span> <span class="nx">i</span>
    <span class="nv">j = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)</span>
    <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="nv">temp = </span><span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
    <span class="nx">v</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">temp</span>
  <span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Count the number of times a value appears in a list, coercing everything
to its string value.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">countStr = </span><span class="nf">(list, elt) -&gt;</span>
  <span class="nv">count = </span><span class="mi">0</span>
  <span class="k">for</span> <span class="nx">member</span> <span class="k">in</span> <span class="nx">list</span>
    <span class="k">if</span> <span class="nx">member</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="nx">elt</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nx">count</span><span class="o">++</span>
  <span class="nx">count</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Sort by numeric value. You'd think this would be in the standard library.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">numericSort = </span><span class="nf">(array) -&gt;</span>
  <span class="nx">array</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="nf">(a, b) -&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="o">-</span><span class="nx">b</span><span class="p">)</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <h2>Exports</h2>

<p>Export the State and PlayerState classes for other modules to use.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nv">State = </span><span class="nx">State</span>
<span class="k">this</span><span class="p">.</span><span class="nv">PlayerState = </span><span class="nx">PlayerState</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <h2>Indecisive imports</h2>

<p>Recall that this code begins with:</p>

<pre><code>{c} = require './cards' if exports?
</code></pre>

<p>This means "get the variable named <code>c</code> from the module <code>./cards</code>. Unless
there's no module system. In that case, don't."</p>

<p>Here's why that is useful. When the code
is running inside node.js, it will use node.js's import system. This
uses the predefined function <code>require</code>, which doesn't exist in a 
Web browser's JS environment.</p>

<p>When running in a web browser, there is no sane way for one module to
import another. Instead,
the typical practice -- which we will use too -- is to just load a bunch of
JavaScript files into the same global namespace.</p>

<p>In that case, the variable <code>c</code> already exists without any additional effort
from us. We're polluting the global namespace and defeating some of the
point of modules, but that's how most JavaScript in the wild works anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 