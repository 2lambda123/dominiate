<!DOCTYPE html>  <html> <head>   <title>gameState.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="basicAI.html">                 basicAI.coffee               </a>                                           <a class="source" href="cards.html">                 cards.coffee               </a>                                           <a class="source" href="compileStrategies.html">                 compileStrategies.coffee               </a>                                           <a class="source" href="gameState.html">                 gameState.coffee               </a>                                           <a class="source" href="heuristics.html">                 heuristics.coffee               </a>                                           <a class="source" href="play.html">                 play.coffee               </a>                                           <a class="source" href="playWeb.html">                 playWeb.coffee               </a>                                           <a class="source" href="testSimulation.html">                 testSimulation.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               gameState.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This "indecisive import" pattern is messy but it gets the job done, and it's
explained at the bottom of this documentation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">c</span><span class="p">,</span><span class="nx">transferCard</span><span class="p">,</span><span class="nx">transferCardToTop</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./cards&#39;</span> <span class="k">if</span> <span class="nx">exports</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>The PlayerState class</h2>

<p>A PlayerState stores the part of the game state
that is specific to each player, plus what AI is making the decisions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">PlayerState</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>At the start of the game, the State should
.initialize() each PlayerState, which assigns its AI and sets up its
starting state. Before then, it is an empty object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialize: </span><span class="nf">(ai, logFunc) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>These attributes of the PlayerState are okay for card effects and
AI strategies to refer to.</p>

<p>Often, you will want to find out something
about the player whose turn it is, who will appear as <code>state.current</code>.
For example, if you want to know how many actions the current player
has, you can look up <code>state.current.actions</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@actions = </span><span class="mi">1</span>
    <span class="vi">@buys = </span><span class="mi">1</span>
    <span class="vi">@coins = </span><span class="mi">0</span>
    <span class="vi">@potions = </span><span class="mi">0</span>
    <span class="vi">@multipliedDurations = </span><span class="p">[]</span>
    <span class="vi">@chips = </span><span class="mi">0</span>
    <span class="vi">@hand = </span><span class="p">[]</span>
    <span class="vi">@discard = </span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>A mat is a place where cards can store inter-turn state for a player.
It can correspond to a physical mat, like the Island or Pirate Ship
Mat or just a place to set things aside for cards like Haven.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@mats = </span><span class="p">{}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>If you want to ask what's in a player's draw pile, be sure to only do
it to a <em>hypothetical</em> PlayerState that you retrieve with
<code>state.hypothetical(ai)</code>. Then the draw pile will contain a random
guess, as opposed to the actual hidden information.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@draw = </span><span class="p">[]</span>
    <span class="vi">@inPlay = </span><span class="p">[]</span>
    <span class="vi">@duration = </span><span class="p">[]</span>
    <span class="vi">@setAside = </span><span class="p">[]</span>
    <span class="vi">@gainedThisTurn = </span><span class="p">[]</span>
    <span class="vi">@turnsTaken = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>To stack various card effects, we'll have to keep track of the location
of the card we're playing and the card we're gaining. For example, if
you have two Feasts in hand and you Throne Room a Feast, you don't
trash <em>both</em> Feasts -- you trash one and then do nothing, based on the
fact that <em>that particular</em> Feast is already in the trash.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@playLocation = </span><span class="s1">&#39;inPlay&#39;</span>
    <span class="vi">@gainLocation = </span><span class="s1">&#39;discard&#39;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The <code>actionStack</code> is not a physical location for cards to be in; it's
a computational list of what actions are in play but not yet resolved.
This becomes particularly important with King's Courts.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@actionStack = </span><span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Set the properties passed in from the State.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@ai = </span><span class="nx">ai</span>
    <span class="vi">@logFunc = </span><span class="nx">logFunc</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>To start the game, the player starts with the 10 starting cards
in the discard pile, then shuffles them and draws 5.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Informational methods</h3>

<p>The methods here ask about general properties of a player's deck,
discard pile, and so on. A number of similar methods appear on the <code>State</code>
class defined below, which deal with information that is not so
player-specific, such as the cards in the supply.</p>

<p>As an example:
Most AI code will start with a reference to the State, called <code>state</code>.
If you want to check the number of cards in the current player's deck,
you would ask the <em>player object</em> <code>state.current</code>:</p>

<p>state.current.numCardsInDeck()</p>

<p>If you want to check how many piles are currently empty, you would ask
the <em>state object</em> itself:</p>

<p>state.numEmptyPiles()</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><code>getDeck()</code> returns all the cards in the player's deck, even those in
strange places such as the Island mat.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getDeck: </span><span class="nf">() -&gt;</span>
    <span class="nv">result = </span><span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@draw</span><span class="p">,</span> <span class="nx">@discard</span><span class="p">,</span> <span class="nx">@hand</span><span class="p">,</span> <span class="nx">@inPlay</span><span class="p">,</span> <span class="nx">@duration</span><span class="p">,</span> <span class="nx">@setAside</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">contents</span> <span class="k">of</span> <span class="nx">@mats</span> <span class="k">when</span> <span class="nx">contents</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If contents is a card or an array containing cards, add it to the list</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;playEffect&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;playEffect&#39;</span><span class="p">)</span>
        <span class="nv">result = </span><span class="nx">result</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span>
    <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><code>getCurrentAction()</code> returns the action being resolved that is on the
top of the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCurrentAction: </span><span class="nf">() -&gt;</span>
    <span class="nx">@actionStack</span><span class="p">[</span><span class="nx">@actionStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>getMultiplier()</code> gets the value of the multipier that is currently being
played: 1 in most cases, 2 after playing Throne Room, 3 after playing
King's Court.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getMultiplier: </span><span class="nf">() -&gt;</span>
    <span class="nv">action = </span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentAction</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">action</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">action</span><span class="p">.</span><span class="nx">getMultiplier</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><code>countInDeck(card)</code> counts the number of copies of a card in the deck.
The card may be specified either by name or as a card object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInDeck: </span><span class="nf">(card) -&gt;</span>
    <span class="nv">count = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card2</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="nx">card2</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">count</span><span class="o">++</span>
    <span class="nx">count</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><code>numCardsInDeck()</code> returns the size of the player's deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">numCardsInDeck: </span><span class="nf">() -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">().</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Aliases for <code>numCardsInDeck</code> that you might use intuitively. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countCardsInDeck: </span><span class="k">this</span><span class="p">.</span><span class="nx">numCardsInDeck</span>
  <span class="nv">cardsInDeck: </span><span class="k">this</span><span class="p">.</span><span class="nx">numCardsInDeck</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>countCardTypeInDeck(type)</code> counts the number of cards of a given type
in the deck. Curse is not a type for these purposes, it's a card.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countCardTypeInDeck: </span><span class="nf">(type) -&gt;</span>
    <span class="nv">typeChecker = </span><span class="s1">&#39;is&#39;</span><span class="o">+</span><span class="nx">type</span>
    <span class="nv">count = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">[</span><span class="nx">typeChecker</span><span class="p">]</span>
        <span class="nx">count</span><span class="o">++</span>
    <span class="nx">count</span>
  <span class="nv">numCardTypeInDeck: </span><span class="k">this</span><span class="p">.</span><span class="nx">countCardTypeInDeck</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><code>getVP()</code> returns the number of VP the player would have if the game
ended now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getVP: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">total = </span><span class="nx">@chips</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="nx">total</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getVP</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">total</span>
  <span class="nv">countVP: </span><span class="k">this</span><span class="p">.</span><span class="nx">getVP</span>
  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><code>getTotalMoney()</code> adds up the total money in the player's deck,
including both Treasure and +$x, +y Actions cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getTotalMoney: </span><span class="nf">() -&gt;</span>
    <span class="nv">total = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span> <span class="o">or</span> <span class="nx">card</span><span class="p">.</span><span class="nx">actions</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="nx">total</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">coins</span>
    <span class="nx">total</span>
  <span class="nv">totalMoney: </span><span class="k">this</span><span class="p">.</span><span class="nx">getTotalMoney</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><code>getAvailableMoney()</code> counts the money the player might have upon playing
all treasure in hand. Banks, Ventures, and such are counted inaccurately
so far.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getAvailableMoney: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTreasureInHand</span><span class="p">()</span>
  <span class="nv">availableMoney: </span><span class="k">this</span><span class="p">.</span><span class="nx">getAvailableMoney</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><code>getTreasureInHand()</code> adds up the value of the treasure in the player's
hand. Banks and Ventures and such will be inaccurate.</p>

<p>A <code>getMoneyInHand(state)</code> method that counted playable action cards would
be great, but I'm skipping it for now because it's difficult to get right.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getTreasureInHand: </span><span class="nf">() -&gt;</span>
    <span class="nv">total = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">hand</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nx">total</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">coins</span>
    <span class="nx">total</span>
  <span class="nv">treasureInHand: </span><span class="k">this</span><span class="p">.</span><span class="nx">getTreasureInHand</span>
  
  <span class="nv">countPlayableTerminals: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">@actions</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">@actions</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="p">(</span><span class="nx">card</span><span class="p">.</span><span class="nx">getActions</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">hand</span><span class="p">).</span><span class="nx">reduce</span> <span class="nf">(s,t) -&gt;</span> <span class="nx">s</span> <span class="o">+</span> <span class="nx">t</span><span class="p">)</span>
    <span class="k">else</span> <span class="mi">0</span>
  <span class="nv">numPlayableTerminals: </span><span class="k">this</span><span class="p">.</span><span class="nx">countPlayableTerminals</span>    
  <span class="nv">playableTerminals: </span><span class="k">this</span><span class="p">.</span><span class="nx">countPlayableTerminals</span>    
   </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><code>countInHand(card)</code> counts the number of copies of a card in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInHand: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">countStr</span><span class="p">(</span><span class="nx">@hand</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><code>countInDiscard(card)</code> counts the number of copies of a card in the discard
pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInDiscard: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">countStr</span><span class="p">(</span><span class="nx">@discard</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><code>countInPlay(card)</code>
counts the number of copies of a card in play. Don't use this
for evaluating effects that stack, because you may also need
to take Throne Rooms and King's Courts into account.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInPlay: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">countStr</span><span class="p">(</span><span class="nx">@inPlay</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><code>numActionCardsInDeck()</code> is the number of action cards in the player's
entire deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">numActionCardsInDeck: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">countCardTypeInDeck</span><span class="p">(</span><span class="s1">&#39;Action&#39;</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><code>getActionDensity()</code> returns a fractional value, between 0.0 and 1.0,
representing the proportion of actions in the deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getActionDensity: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">numActionCardsInDeck</span><span class="p">()</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">().</span><span class="nx">length</span>
  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><code>menagerieDraws()</code> is the number of cards the player would draw upon
playing a Menagerie: either 1 or 3.</p>

<p><em>TODO</em>: allow for a hypothetical version where it's okay to have another
Menagerie.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">menagerieDraws: </span><span class="nf">() -&gt;</span>
    <span class="nv">seen = </span><span class="p">{}</span>
    <span class="nv">cardsToDraw = </span><span class="mi">3</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">if</span> <span class="nx">seen</span><span class="p">[</span><span class="nx">card</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">cardsToDraw = </span><span class="mi">1</span>
        <span class="k">break</span>
      <span class="nx">seen</span><span class="p">[</span><span class="nx">card</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">cardsToDraw</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><code>shantyTownDraws()</code> is the number of cards the player draws upon
playing a Shanty town: either 0 or 2.</p>

<p>Set <code>hypothetical</code> to <code>true</code> if deciding whether to play a Shanty Town
(because it won't be in your hand anymore when you do).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shantyTownDraws: </span><span class="nf">(hypothetical = false) -&gt;</span>
    <span class="nv">cardsToDraw = </span><span class="mi">2</span>
    <span class="nv">skippedShanty = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="k">if</span> <span class="nx">hypothetical</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">skippedShanty</span>
          <span class="nv">skippedShanty = </span><span class="kc">true</span>
        <span class="k">else</span>
          <span class="nv">cardsToDraw = </span><span class="mi">0</span>
          <span class="k">break</span>
    <span class="nx">cardsToDraw</span>
  </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p><code>actionBalance()</code> is a complex method meant to be used by AIs in
deciding whether they want +actions or +cards, for example.</p>

<p>If the actionBalance is
less than 0, you want +actions, because otherwise you will have dead
action cards in hand or risk drawing them dead. If it is greater than
0, you want +cards, because you have a surplus of actions and need
action cards to spend them on.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">actionBalance: </span><span class="nf">() -&gt;</span>
    <span class="nv">balance = </span><span class="nx">@actions</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@hand</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">balance</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">actions</span>
        <span class="nx">balance</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Estimate the risk of drawing an action card dead.</p>

<p><em>TODO</em>: do something better when there are variable card-drawers.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">actions</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="nx">balance</span> <span class="o">-=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">cards</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActionDensity</span><span class="p">()</span>
    <span class="nx">balance</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p><code>deckActionBalance()</code> is a measure of action balance across the entire
deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">deckActionBalance: </span><span class="nf">() -&gt;</span>
    <span class="nv">balance = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">balance</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">actions</span>
        <span class="nx">balance</span><span class="o">--</span>
    <span class="k">return</span> <span class="nx">balance</span> <span class="err">/ this.numCardsInDeck()</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>What is the trashing power of this hand?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">trashingInHand: </span><span class="nf">() -&gt;</span>
    <span class="nv">trash = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">hand</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Count actions that simply trash a constant number of cards from hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">trash</span> <span class="o">+=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">trash</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Add other trashers, including the trash-on-gain power of Watchtower.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Steward</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Trading Post&#39;</span><span class="p">]</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">4</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Chapel</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Masquerade</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Ambassador</span>
      <span class="nx">trash</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Watchtower</span>
    <span class="k">return</span> <span class="nx">trash</span>
  
  <span class="nv">numUniqueCardsInPlay: </span><span class="nf">() -&gt;</span>
    <span class="nv">unique = </span><span class="p">[]</span>
    <span class="nv">cards = </span><span class="nx">@inPlay</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@duration</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">cards</span>
      <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">unique</span>
        <span class="nx">unique</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">unique</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">countUniqueCardsInPlay: </span><span class="k">this</span><span class="p">.</span><span class="nx">numUniqueCardsInPlay</span>
  <span class="nv">uniqueCardsInPlay: </span><span class="k">this</span><span class="p">.</span><span class="nx">numUniqueCardsInPlay</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h3>Methods that modify the PlayerState</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawCards: </span><span class="nf">(nCards) -&gt;</span>
    <span class="nv">drawn = </span><span class="k">this</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">nCards</span><span class="p">)</span>
    <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@hand</span><span class="p">,</span> <span class="nx">drawn</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@ai} draws #{drawn.length} cards: #{drawn}.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">drawn</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><code>getCardsFromDeck</code> is a sub-method of many things that need to happen
with the game. It takes <code>nCards</code> cards off the deck, and then
<em>returns</em> them so you can do something with them.</p>

<p>Code that calls <code>getCardsFromDeck</code>
is responsible for making sure the cards aren't just "dropped on the
floor" after that, so to speak.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCardsFromDeck: </span><span class="nf">(nCards) -&gt;</span>
    <span class="k">if</span> <span class="nx">@draw</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">nCards</span>
      <span class="nv">diff = </span><span class="nx">nCards</span> <span class="o">-</span> <span class="nx">@draw</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">drawn = </span><span class="nx">@draw</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="vi">@draw = </span><span class="p">[]</span>
      <span class="k">if</span> <span class="nx">@discard</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">diff</span><span class="p">))</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">drawn</span>
        
    <span class="k">else</span>
      <span class="nv">drawn = </span><span class="nx">@draw</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nCards</span><span class="p">]</span>
      <span class="vi">@draw = </span><span class="nx">@draw</span><span class="p">[</span><span class="nx">nCards</span><span class="p">...]</span>
      <span class="k">return</span> <span class="nx">drawn</span>
  </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p><code>dig</code> is a function to draw and reveal cards from the deck until
certain ones are found. The cards to be found are defined by digFunc,
which takes (state, card) and returns true if card is one that we're
trying find. For example, Venture's and Adventurer's would be
digFunc: (state, card) -> card.isTreasure</p>

<p>nCards is the number of cards we're looking for; usually 1, but Golem
and Adventurer look for 2 cards.</p>

<p>By default, discard the revealed and set aside cards, but Scrying Pool
digs for a card that is not an action, then draws up all the revealed
actions as well; discardSetAside allows a card calling dig to do
something with setAside other than discarding.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dig: </span><span class="nf">(state, digFunc, nCards=1, discardSetAside=true) -&gt;</span>
    <span class="nv">foundCards = </span><span class="p">[]</span> <span class="c1"># These are the cards you&#39;re looking for</span>
    <span class="nv">revealedCards = </span><span class="p">[]</span> <span class="c1"># All the cards drawn and revealed from the deck</span>
    <span class="k">while</span> <span class="nx">foundCards</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">nCards</span>
      <span class="nv">drawn = </span><span class="k">this</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">revealedCards</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">digFunc</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
        <span class="nx">foundCards</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">revealedCards</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{this.ai} has no cards to draw.&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{this.ai} reveals #{revealedCards}.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">discardSetAside</span>
      <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{this.ai} discards #{this.setAside}.&quot;</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nv">discard = </span><span class="k">this</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">setAside</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAside</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nv">setAside = </span><span class="p">[]</span>
    <span class="nx">foundCards</span>
  
  <span class="nv">discardFromDeck: </span><span class="nf">(nCards) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;discardFromDeck is done by the state now&quot;</span><span class="p">)</span>
  
  <span class="nv">doDiscard: </span><span class="nf">(card) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;doDiscard is done by the state now&quot;</span><span class="p">)</span>
  
  <span class="nv">doTrash: </span><span class="nf">(card) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;doTrash is done by the state now&quot;</span><span class="p">)</span>

  <span class="nv">doPutOnDeck: </span><span class="nf">(card) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;doPutOnDeck is done by the state now&quot;</span><span class="p">)</span>
  
  <span class="nv">shuffle: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;(#{@ai} shuffles.)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@draw</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Shuffling while there are cards left to draw&quot;</span><span class="p">)</span>
    <span class="nx">shuffle</span><span class="p">(</span><span class="nx">@discard</span><span class="p">)</span>
    <span class="vi">@draw = </span><span class="nx">@discard</span>
    <span class="vi">@discard = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>TODO: add an AI decision for Stashes</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Most PlayerStates are created by copying an existing one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">copy: </span><span class="nf">() -&gt;</span>
    <span class="nv">other = </span><span class="k">new</span> <span class="nx">PlayerState</span><span class="p">()</span>
    <span class="nv">other.actions = </span><span class="nx">@actions</span>
    <span class="nv">other.buys = </span><span class="nx">@buys</span>
    <span class="nv">other.coins = </span><span class="nx">@coins</span>
    <span class="nv">other.potions = </span><span class="nx">@potions</span>
    <span class="nv">other.multipliedDurations = </span><span class="nx">@multipliedDurations</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Clone mat contents, deep-copying arrays of cards</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">other.mats = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">contents</span> <span class="k">of</span> <span class="nx">@mats</span>
      <span class="k">if</span> <span class="nx">contents</span> <span class="k">instanceof</span> <span class="nb">Array</span>
        <span class="nv">contents = </span><span class="nx">contents</span><span class="p">.</span><span class="nx">concat</span><span class="p">()</span>
      <span class="nx">other</span><span class="p">.</span><span class="nx">mats</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">contents</span>

    <span class="nv">other.chips = </span><span class="nx">@chips</span>
    <span class="nv">other.hand = </span><span class="nx">@hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.draw = </span><span class="nx">@draw</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.discard = </span><span class="nx">@discard</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.inPlay = </span><span class="nx">@inPlay</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.duration = </span><span class="nx">@duration</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.setAside = </span><span class="nx">@setAside</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.gainedThisTurn = </span><span class="nx">@gainedThisTurn</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.playLocation = </span><span class="nx">@playLocation</span>
    <span class="nv">other.gainLocation = </span><span class="nx">@gainLocation</span>
    <span class="nv">other.actionStack = </span><span class="nx">@actionStack</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">other.actionsPlayed = </span><span class="nx">@actionsPlayed</span>
    <span class="nv">other.ai = </span><span class="nx">@ai</span>
    <span class="nv">other.logFunc = </span><span class="nx">@logFunc</span>
    <span class="nv">other.turnsTaken = </span><span class="nx">@turnsTaken</span>
    <span class="nx">other</span>
  </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Games can provide output using the <code>log</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">log: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="o">?</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">console</span><span class="o">?</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h2>The State class</h2>

<p>A State instance stores the complete state of the game at a point in time.</p>

<p>Almost all operations work by changing the game state. This means that if
AI code wants to evaluate potential decisions, it should do them using a
copy of the state (often one with hidden information in it).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">State</span>
  <span class="nv">basicSupply: </span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">,</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Duchy</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Province</span><span class="p">]</span>
  <span class="nv">extraSupply: </span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Potion</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Platinum</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Colony</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>AIs can get at the <code>c</code> object that stores information about cards
by looking up <code>state.cardInfo</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cardInfo: </span><span class="nx">c</span>
  </pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Set up the state at the start of the game. Takes these arguments:</p>

<ul>
<li><code>ais</code>: a list of AI objects that will make the decisions, one per player.
This sets the number of players in the game.</li>
<li><code>tableau</code>: the list of non-basic cards in the supply. Colony, Platinum,
and Potion have to be listed explicitly.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialize: </span><span class="nf">(ais, tableau, logFunc) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nv">logFunc = </span><span class="nx">logFunc</span>
    <span class="vi">@players = </span><span class="p">(</span><span class="k">new</span> <span class="nx">PlayerState</span><span class="p">().</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">ai</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="p">)</span> <span class="k">for</span> <span class="nx">ai</span> <span class="k">in</span> <span class="nx">ais</span><span class="p">)</span>
    <span class="vi">@players = </span><span class="p">[]</span>
    <span class="nv">playerNum = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">ai</span> <span class="k">in</span> <span class="nx">ais</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>playerNum += 1
if ai.name[2] == ':'
 ai.name = ai.name[3...]
ai.name = "P#{playerNum}:#{ai.name}"</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">player = </span><span class="k">new</span> <span class="nx">PlayerState</span><span class="p">().</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">ai</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="p">)</span>
      <span class="nx">@players</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>

    <span class="vi">@nPlayers = </span><span class="nx">@players</span><span class="p">.</span><span class="nx">length</span>
    <span class="vi">@current = </span><span class="nx">@players</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="vi">@supply = </span><span class="k">this</span><span class="p">.</span><span class="nx">makeSupply</span><span class="p">(</span><span class="nx">tableau</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Cards like Tournament or Black Market may put cards in a special supply</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@specialSupply = </span><span class="p">{}</span>
    <span class="vi">@trash = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>A map of Card to state object that allows cards to define lasting state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@cardState = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>A list of objects which have a "modify" method that takes a card and returns
a modification to its cost.  Objects must also have a "source" property that
specifies which card caused the cost modification.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@costModifiers = </span><span class="p">[]</span>

    <span class="vi">@copperValue = </span><span class="mi">1</span>
    <span class="vi">@phase = </span><span class="s1">&#39;start&#39;</span>
    <span class="vi">@extraturn = </span><span class="kc">false</span>
    
    <span class="vi">@cache = </span><span class="p">{}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>The <code>depth</code> indicates how deep into hypothetical situations we are. A depth of 0
indicates the state of the actual game.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@depth = </span><span class="mi">0</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Tableau: #{tableau}&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Let cards in the tableau know the game is starting so they can perform
any necessary initialization</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">tableau</span>
      <span class="nx">card</span><span class="p">.</span><span class="nx">startGameEffect</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p><code>totalCards</code> tracks the total number of cards that are in the game. If it changes,
we screwed up.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@totalCards = </span><span class="k">this</span><span class="p">.</span><span class="nx">countTotalCards</span><span class="p">()</span>

    <span class="k">return</span> <span class="k">this</span>
  </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p><code>setUpWithOptions</code> is the function I'd like to use as the primary way of setting up
a new game, doing the work of choosing a set of kingdom and extra cards (what I call
the tableau) with the cards they require plus random cards, and handling options.</p>

<p>It takes two arguments, <code>ais</code> and <code>options</code>. <code>ais</code> is the list of AI objects, and
<code>options</code> is an object with these keys and values:</p>

<ul>
<li><code>randomizeOrder</code>: whether to shuffle the player order. Defaults to true.</li>
<li><code>colonies</code>: whether to add Colonies and Platinums to the tableau. Defaults
to false-ish: it can be set to true by a strategy that requires Colony if
left undefined.</li>
<li>`log</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setUpWithOptions: </span><span class="nf">(ais, options) -&gt;</span>
    <span class="nv">tableau = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">require</span><span class="o">?</span>
      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">require</span>
        <span class="nx">tableau</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">])</span>
    <span class="k">for</span> <span class="nx">ai</span> <span class="k">in</span> <span class="nx">ais</span>
      <span class="k">if</span> <span class="nx">ai</span><span class="p">.</span><span class="nx">requires</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">ai</span><span class="p">.</span><span class="nx">requires</span>
          <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">card</span> <span class="k">in</span> <span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Colony</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Platinum</span><span class="p">]</span>
            <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">colonies</span><span class="o">?</span>
              <span class="nv">options.colonies = </span><span class="kc">true</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">colonies</span> <span class="o">is</span> <span class="kc">false</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;This setup forbids Colonies, but #{ai} requires them&quot;</span><span class="p">)</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">tableau</span> <span class="o">and</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">basicSupply</span><span class="o">\</span>
               <span class="o">and</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">extraSupply</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isPrize</span>
            <span class="nx">tableau</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;These strategies require too many different cards to play against each other.&quot;</span><span class="p">)</span>
    
    <span class="nv">index = </span><span class="mi">0</span>
    <span class="nv">moreCards = </span><span class="nx">c</span><span class="p">.</span><span class="nx">allCards</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nx">shuffle</span><span class="p">(</span><span class="nx">moreCards</span><span class="p">)</span>
    <span class="k">while</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">10</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">moreCards</span><span class="p">[</span><span class="nx">index</span><span class="p">]]</span>
      <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">card</span> <span class="k">in</span> <span class="nx">tableau</span> <span class="o">or</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">basicSupply</span> <span class="o">or</span> <span class="nx">card</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">extraSupply</span> <span class="o">or</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isPrize</span><span class="p">)</span>
        <span class="nx">tableau</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="nx">index</span><span class="o">++</span>

    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">colonies</span>
      <span class="nx">tableau</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Colony</span><span class="p">)</span>
      <span class="nx">tableau</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Platinum</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">tableau</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">costPotion</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Potion</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">tableau</span>
          <span class="nx">tableau</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Potion</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">randomizeOrder</span>
      <span class="nx">shuffle</span><span class="p">(</span><span class="nx">ais</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">ais</span><span class="p">,</span> <span class="nx">tableau</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">log</span> <span class="o">?</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Given the tableau (the set of non-basic cards in play), construct the
appropriate supply for the number of players.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeSupply: </span><span class="nf">(tableau) -&gt;</span>
    <span class="nv">allCards = </span><span class="k">this</span><span class="p">.</span><span class="nx">basicSupply</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">tableau</span><span class="p">)</span>
    <span class="nv">supply = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">allCards</span>
      <span class="k">if</span> <span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">].</span><span class="nx">startingSupply</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">?</span> <span class="nx">card</span>
        <span class="nx">supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">startingSupply</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">supply</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h3>Informational methods</h3>

<p>These methods are referred to by some card effects, but can also be useful
in crafting a strategy.</p>

<p><code>emptyPiles()</code> determines which supply piles are empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">emptyPiles: </span><span class="nf">() -&gt;</span>
    <span class="nv">piles = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@supply</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nx">piles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">piles</span>
  </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p><code>numEmptyPiles()</code> simply returns the number of empty piles.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">numEmptyPiles: </span><span class="nf">() -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emptyPiles</span><span class="p">().</span><span class="nx">length</span>
  </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p><code>gameIsOver()</code> returns whether the game is over.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gameIsOver: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>The game can only end after a player has taken a full turn. Check that
by making sure the phase is <code>'start'</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@phase</span> <span class="o">!=</span> <span class="s1">&#39;start&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Check all the conditions in which empty piles can end the game.
Add a fake game-ending condition, too, which is a stalemate the SillyAI
sometimes ends up in.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">emptyPiles = </span><span class="k">this</span><span class="p">.</span><span class="nx">emptyPiles</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">emptyPiles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">totalPilesToEndGame</span><span class="p">()</span> <span class="o">\</span>
        <span class="o">or</span> <span class="p">(</span><span class="nx">@nPlayers</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">and</span> <span class="nx">emptyPiles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">\</span>
        <span class="o">or</span> <span class="s1">&#39;Province&#39;</span> <span class="k">in</span> <span class="nx">emptyPiles</span> <span class="o">\</span>
        <span class="o">or</span> <span class="s1">&#39;Colony&#39;</span> <span class="k">in</span> <span class="nx">emptyPiles</span> <span class="o">\</span>
        <span class="o">or</span> <span class="p">(</span><span class="s1">&#39;Curse&#39;</span> <span class="k">in</span> <span class="nx">emptyPiles</span> <span class="o">and</span> <span class="s1">&#39;Copper&#39;</span> <span class="k">in</span> <span class="nx">emptyPiles</span> <span class="o">and</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">turnsTaken</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Empty piles: #{emptyPiles}&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">playerName</span><span class="p">,</span> <span class="nx">vp</span><span class="p">,</span> <span class="nx">turns</span><span class="p">]</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getFinalStatus</span><span class="p">()</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{playerName} took #{turns} turns and scored #{vp} points.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p><code>getFinalStatus()</code> is a useful thing to call when <code>gameIsOver()</code> is true.
It returns a list of triples of [player name, score, turns taken].</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getFinalStatus: </span><span class="nf">() -&gt;</span>
    <span class="p">([</span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">player</span><span class="p">.</span><span class="nx">getVP</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">player</span><span class="p">.</span><span class="nx">turnsTaken</span><span class="p">]</span> <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">@players</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p><code>getWinners()</code> returns a list (usually of length 1) of the names of players
that won the game, or would win if it were over now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getWinners: </span><span class="nf">() -&gt;</span>
    <span class="nv">scores = </span><span class="k">this</span><span class="p">.</span><span class="nx">getFinalStatus</span><span class="p">()</span>
    <span class="nv">best = </span><span class="p">[]</span>
    <span class="nv">bestScore = </span><span class="o">-</span><span class="kc">Infinity</span>
    
    <span class="k">for</span> <span class="p">[</span><span class="nx">player</span><span class="p">,</span> <span class="nx">score</span><span class="p">,</span> <span class="nx">turns</span><span class="p">]</span> <span class="k">in</span> <span class="nx">scores</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Modify the score by subtracting a fraction of turnsTaken.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">modScore = </span><span class="nx">score</span> <span class="o">-</span> <span class="nx">turns</span><span class="err">/100</span>

      <span class="k">if</span> <span class="nx">modScore</span> <span class="o">==</span> <span class="nx">bestScore</span>
        <span class="nx">best</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">modScore</span> <span class="o">&gt;</span> <span class="nx">bestScore</span>
        <span class="nv">best = </span><span class="p">[</span><span class="nx">player</span><span class="p">]</span>
        <span class="nv">bestScore = </span><span class="nx">modScore</span>
    <span class="nx">best</span>
  </pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p><code>countInSupply()</code> returns the number of copies of a card that remain
in the supply. It can take in either a card object or card name.</p>

<p>If the card has never been in the supply, it returns 0,
so it is safe to refer to <code>state.countInSupply('Colony')</code> even in
a non-Colony game. This does not count as an empty pile, of course.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countInSupply: </span><span class="nf">(card) -&gt;</span>
    <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span>
  </pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p><code>totalPilesToEndGame()</code> returns the number of empty piles that triggers
the end of the game, which is almost always 3.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">totalPilesToEndGame: </span><span class="nf">() -&gt;</span>
    <span class="k">switch</span> <span class="nx">@nPlayers</span>
      <span class="k">when</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="k">then</span> <span class="mi">3</span>
      <span class="k">else</span> <span class="mi">4</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>As a useful heuristic, <code>gainsToEndGame()</code> returns the minimum number of
buys/gains that would have to be used by an opponent who is determined to
end the game. A low number means the game is probably ending soon.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainsToEndGame: </span><span class="nf">() -&gt;</span>
    <span class="k">if</span> <span class="nx">@cache</span><span class="p">.</span><span class="nx">gainsToEndGame</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">@cache</span><span class="p">.</span><span class="nx">gainsToEndGame</span>
    <span class="nv">counts = </span><span class="p">(</span><span class="nx">count</span> <span class="k">for</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">count</span> <span class="k">of</span> <span class="nx">@supply</span><span class="p">)</span>
    <span class="nx">numericSort</span><span class="p">(</span><span class="nx">counts</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>First, add up the smallest 3 (or 4) piles.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">piles = </span><span class="k">this</span><span class="p">.</span><span class="nx">totalPilesToEndGame</span><span class="p">()</span>
    <span class="nv">minimum = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">count</span> <span class="k">in</span> <span class="nx">counts</span><span class="p">[...</span><span class="nx">piles</span><span class="p">]</span>
      <span class="nx">minimum</span> <span class="o">+=</span> <span class="nx">count</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Then compare this to the number of Provinces or possibly Colonies
remaining, and see which one is smallest.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">minimum = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minimum</span><span class="p">,</span> <span class="nx">@supply</span><span class="p">[</span><span class="s1">&#39;Province&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">@supply</span><span class="p">[</span><span class="s1">&#39;Colony&#39;</span><span class="p">]</span><span class="o">?</span>
      <span class="nv">minimum = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minimum</span><span class="p">,</span> <span class="nx">@supply</span><span class="p">[</span><span class="s1">&#39;Colony&#39;</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Cache the result; apparently it's expensive to compute.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@cache.gainsToEndGame = </span><span class="nx">minimum</span>
    <span class="nx">minimum</span>
  </pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p><code>smugglerChoices</code> determines the set of cards that could be gained with a
Smuggler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">smugglerChoices: </span><span class="nf">() -&gt;</span>
    <span class="nv">choices = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span>
    <span class="nv">prevPlayer = </span><span class="nx">@players</span><span class="p">[</span><span class="nx">@nPlayers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">prevPlayer</span><span class="p">.</span><span class="nx">gainedThisTurn</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">potions</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;=</span> <span class="mi">6</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">choices</span>
  </pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p><code>countTotalCards</code> counts the number of cards that exist anywhere.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">countTotalCards: </span><span class="nf">() -&gt;</span>
    <span class="nv">total = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">@players</span>
      <span class="nx">total</span> <span class="o">+=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">numCardsInDeck</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">count</span> <span class="k">of</span> <span class="nx">@supply</span>
      <span class="nx">total</span> <span class="o">+=</span> <span class="nx">count</span>
    <span class="k">for</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">count</span> <span class="k">of</span> <span class="nx">@specialSupply</span>
      <span class="nx">total</span> <span class="o">+=</span> <span class="nx">count</span>
    <span class="nx">total</span> <span class="o">+=</span> <span class="nx">@trash</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">total</span>
    
  <span class="nv">buyCausesToLose: </span><span class="nf">(player, state, card) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">card</span><span class="o">?</span> <span class="o">||</span> <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">gainsToEndGame</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Check to see if the player would be in the lead after buying this card</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">maxOpponentScore = </span><span class="o">-</span><span class="kc">Infinity</span>
    <span class="k">for</span> <span class="nx">status</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">getFinalStatus</span><span class="p">()</span>
      <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">score</span><span class="p">,</span> <span class="nx">turns</span><span class="p">]</span> <span class="o">=</span> <span class="nx">status</span>
      <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nv">myScore = </span><span class="nx">score</span> <span class="o">+</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getVP</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">score</span> <span class="o">&gt;</span> <span class="nx">maxOpponentScore</span>
        <span class="nv">maxOpponentScore = </span><span class="nx">score</span>

    <span class="k">if</span> <span class="nx">myScore</span> <span class="o">&gt;</span> <span class="nx">maxOpponentScore</span>
      <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>One level of recursion is enough for first</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">depth</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">[</span><span class="nx">hypState</span><span class="p">,</span> <span class="nx">hypMy</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">hypothetical</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>try to buy this card
C&amp;P from below</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">coinCost</span><span class="p">,</span> <span class="nx">potionCost</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">hypMy</span><span class="p">.</span><span class="nx">coins</span> <span class="o">-=</span> <span class="nx">coinCost</span>
    <span class="nx">hypMy</span><span class="p">.</span><span class="nx">potions</span> <span class="o">-=</span> <span class="nx">potionCost</span>
    <span class="nx">hypMy</span><span class="p">.</span><span class="nx">buys</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="nx">hypState</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">hypMy</span><span class="p">,</span> <span class="nx">card</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nx">card</span><span class="p">.</span><span class="nx">onBuy</span><span class="p">(</span><span class="nx">hypState</span><span class="p">)</span>
      

    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">hypMy</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">cardInPlay = </span><span class="nx">hypMy</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">cardInPlay</span><span class="o">?</span>
        <span class="nx">cardInPlay</span><span class="p">.</span><span class="nx">buyInPlayEffect</span><span class="p">(</span><span class="nx">hypState</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>

      <span class="nv">goonses = </span><span class="nx">hypMy</span><span class="p">.</span><span class="nx">countInPlay</span><span class="p">(</span><span class="s1">&#39;Goons&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">goonses</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...gaining #{goonses} VP.&quot;</span><span class="p">)</span>
        <span class="nx">hypMy</span><span class="p">.</span><span class="nx">chips</span> <span class="o">+=</span> <span class="nx">goonses</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>C&amp;P until here</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>finish buyPhase</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">hypState</span><span class="p">.</span><span class="nx">doBuyPhase</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>find out if game ended and who if we have won it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">hypState.phase = </span><span class="s1">&#39;start&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">hypState</span><span class="p">.</span><span class="nx">gameIsOver</span><span class="p">()</span> 
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">hypMy</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="k">in</span> <span class="nx">hypState</span><span class="p">.</span><span class="nx">getWinners</span><span class="p">()</span> <span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Buying #{card} will cause #{player.ai} to lose the game&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span>
   </pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <h3>Playing a turn</h3>

<p><code>doPlay</code> performs the next step of the game, which is a particular phase
of a particular player's turn. If the phase is...</p>

<ul>
<li>'start': resolve duration effects, then go to action phase</li>
<li>'action': play and resolve some number of actions, then go to
treasure phase</li>
<li>'treasure': play and resolve some number of treasures, then go to
buy phase</li>
<li>'buy': buy some number of cards, then go to cleanup phase</li>
<li>'cleanup': resolve cleanup effects, discard everything, draw 5 cards,
and go to the start phase of the next player's turn.</li>
</ul>

<p>To play the entire game, iterate <code>doPlay()</code> until <code>gameIsOver()</code>. Putting
this in a single loop would be a bad idea because it would make Web
browsers freeze up. Browser-facing code should return control after each
call to <code>doPlay()</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doPlay: </span><span class="nf">() -&gt;</span>  
    <span class="k">switch</span> <span class="nx">@phase</span>
      <span class="k">when</span> <span class="s1">&#39;start&#39;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">@extraturn</span>
          <span class="nx">@current</span><span class="p">.</span><span class="nx">turnsTaken</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n== #{@current.ai}&#39;s turn #{@current.turnsTaken} ==&quot;</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">doDurationPhase</span><span class="p">()</span>
          <span class="vi">@phase = </span><span class="s1">&#39;action&#39;</span>
        <span class="k">else</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n== #{@current.ai}&#39;s turn #{@current.turnsTaken}+ ==&quot;</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">doDurationPhase</span><span class="p">()</span>
          <span class="vi">@phase = </span><span class="s1">&#39;action&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;action&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doActionPhase</span><span class="p">()</span>
        <span class="vi">@phase = </span><span class="s1">&#39;treasure&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;treasure&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doTreasurePhase</span><span class="p">()</span>
        <span class="vi">@phase = </span><span class="s1">&#39;buy&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;buy&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doBuyPhase</span><span class="p">()</span>
        <span class="vi">@phase = </span><span class="s1">&#39;cleanup&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;cleanup&#39;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doCleanupPhase</span><span class="p">()</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">@extraturn</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">rotatePlayer</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="vi">@phase = </span><span class="s1">&#39;start&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p><code>@current.duration</code> contains all cards that are in play with duration
effects. At the start of the turn, check all of these cards and run their
<code>onDuration</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doDurationPhase: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Clear out the list of cards gained. (We clear it here because this
information is actually used by Smugglers.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.gainedThisTurn = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>iterate backwards because cards might move</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">card = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} resolves the duration effect of #{card}.&quot;</span><span class="p">)</span>
      <span class="nx">card</span><span class="p">.</span><span class="nx">onDuration</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p><code>@current.multipliedDurations</code> contains virtual copies of cards, which
exist because a multiplier was played on a Duration card.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">multipliedDurations</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} resolves the duration effect of #{card} again.&quot;</span><span class="p">)</span>
      <span class="nx">card</span><span class="p">.</span><span class="nx">onDuration</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    
    <span class="vi">@current.multipliedDurations = </span><span class="p">[]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Perform the action phase. Ask the AI repeatedly which action to play,
until there are no more action cards to play or there are no
actions remaining to play them with, or the AI chooses <code>null</code>, indicating
that it doesn't want to play an action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doActionPhase: </span><span class="nf">() -&gt;</span>
    <span class="k">while</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">validActions = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Determine the set of unique actions that may be played.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span> <span class="o">and</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">validActions</span>
          <span class="nx">validActions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Ask the AI for its choice.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">action = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseAction</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validActions</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Remove the action from the hand and put it in the play area.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">action</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} chose an invalid action.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">playAction</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>The current player plays an action from the hand, and performs the effect
of the action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">playAction: </span><span class="nf">(action) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} plays #{action}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Subtract 1 from the action count and perform the action.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    <span class="vi">@current.playLocation = </span><span class="s1">&#39;inPlay&#39;</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resolveAction</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Another event that causes actions to be played, such as Throne Room,
should skip straight to <code>resolveAction</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveAction: </span><span class="nf">(action) -&gt;</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">actionStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">actionsPlayed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nx">action</span><span class="p">.</span><span class="nx">onPlay</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">actionStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>The "treasure phase" is a concept introduced in Prosperity. After playing
actions, you play any number of treasures in some order. This loop
repeats until the AI chooses <code>null</code>, either because there are no treasures
left to play or because it does not want to play any more treasures.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doTreasurePhase: </span><span class="nf">() -&gt;</span>
    <span class="nx">loop</span>
      <span class="nv">validTreasures = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Determine the set of unique treasures that may be played.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span> <span class="o">and</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">validTreasures</span>
          <span class="nx">validTreasures</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Ask the AI for its choice.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">treasure = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseTreasure</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validTreasures</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">treasure</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} plays #{treasure}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Remove the treasure from the hand and put it in the play area.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">treasure</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} chose an invalid treasure&quot;</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">playTreasure</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
  
  <span class="nv">playTreasure: </span><span class="nf">(treasure) -&gt;</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
    <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
    <span class="vi">@current.playLocation = </span><span class="s1">&#39;inPlay&#39;</span>
    <span class="nx">treasure</span><span class="p">.</span><span class="nx">onPlay</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p><code>getSingleBuyDecision</code> determines what single card (or none) the AI
wants to buy in the current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getSingleBuyDecision: </span><span class="nf">() -&gt;</span>
    <span class="nv">buyable = </span><span class="p">[</span><span class="kc">null</span><span class="p">]</span>
    <span class="nv">checkSuicide = </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="k">this</span><span class="p">.</span><span class="nx">gainsToEndGame</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">cardname</span><span class="p">,</span> <span class="nx">count</span> <span class="k">of</span> <span class="nx">@supply</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Because the supply must reference cards by their names, we use
<code>c[cardname]</code> to get the actual object for the card.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardname</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Determine whether each card can be bought in the current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">mayBeBought</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">and</span> <span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">[</span><span class="nx">coinCost</span><span class="p">,</span> <span class="nx">potionCost</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">coinCost</span> <span class="o">&lt;=</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">and</span> <span class="nx">potionCost</span> <span class="o">&lt;=</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">potions</span>
          <span class="nx">buyable</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Don't allow cards that will lose us the game</p>

<p>Note that this just cares for the buyPhase, gains by other means (Workshop) are not covered</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">checkSuicide</span>
      <span class="nv">buyable = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">buyable</span> <span class="k">when</span> <span class="p">(</span><span class="o">not</span> <span class="k">this</span><span class="p">.</span><span class="nx">buyCausesToLose</span><span class="p">(</span><span class="nx">@current</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">card</span><span class="p">)))</span>
        </pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Ask the AI for its choice.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Coins: #{@current.coins}, Potions: #{@current.potions}, Buys: #{@current.buys}&quot;</span><span class="p">)</span>
    <span class="nv">choice = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">buyable</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">choice</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p><code>doBuyPhase</code> steps through the buy phase, asking the AI to choose
a card to buy until it has no buys left or chooses to buy nothing.</p>

<p>Setting <code>hypothetical</code> to true will skip gaining the cards and simply
return the card list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doBuyPhase: </span><span class="nf">() -&gt;</span>
    <span class="k">while</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">buys</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">choice = </span><span class="k">this</span><span class="p">.</span><span class="nx">getSingleBuyDecision</span><span class="p">()</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} buys #{choice}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Update money and buys.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">[</span><span class="nx">coinCost</span><span class="p">,</span> <span class="nx">potionCost</span><span class="p">]</span> <span class="o">=</span> <span class="nx">choice</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">-=</span> <span class="nx">coinCost</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">potions</span> <span class="o">-=</span> <span class="nx">potionCost</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">buys</span> <span class="o">-=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Gain the card and deal with the effects.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">@current</span><span class="p">,</span> <span class="nx">choice</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">choice</span><span class="p">.</span><span class="nx">onBuy</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Handle cards such as Talisman that respond to cards being bought.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">cardInPlay = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>If a Mandarin put cards back on the deck, this card may not be
there anymore. This showed up in a fascinating interaction among
Talisman, Quarry, Border Village, and Mandarin.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">cardInPlay</span><span class="o">?</span>
          <span class="nx">cardInPlay</span><span class="p">.</span><span class="nx">buyInPlayEffect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Handle all the things that happen at the end of the turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doCleanupPhase: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Clean up Walled Villages first</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">actionCardsInPlay = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">actionCardsInPlay</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nx">actionCardsInPlay</span> <span class="o">&lt;=</span> <span class="mi">2</span>  
      <span class="k">while</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Walled Village&#39;</span><span class="p">]</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span>
        <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Walled Village&#39;</span><span class="p">],</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">,</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} returns a Walled Village to the top of the deck.&quot;</span><span class="p">)</span>

    <span class="vi">@extraturn = </span><span class="o">not</span> <span class="nx">@extraturn</span> <span class="o">and</span> <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Outpost&#39;</span><span class="p">]</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Discard old duration cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.discard = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span>
    <span class="vi">@current.duration = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>If there are cards set aside at this point, it probably means something
went wrong in performing an action. But clean them up anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">([</span><span class="s2">&quot;Cards were set aside at the end of turn&quot;</span><span class="p">,</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">])</span>
      <span class="vi">@current.discard = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">setAside</span>
      <span class="vi">@current.setAside = </span><span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Check which multiplier cards ended up in <code>multipliedDurations</code>, which means
they should be cleaned up as if they were duration cards. Remove them once
they're dealt with. Disregard the other cards there for now.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@current</span><span class="p">.</span><span class="nx">multipliedDurations</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">card = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">multipliedDurations</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isMultiplier</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} puts a #{card} in the duration area.&quot;</span><span class="p">)</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">multipliedDurations</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Handle effects of cleaning up the card, which may involve moving it
somewhere else.  We do this before removing cards from play because
cards such as Scheme and Herbalist need to consider cards in play.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">cardsToCleanup = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">concat</span><span class="p">().</span><span class="nx">reverse</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">cardsToCleanup</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">card = </span><span class="nx">cardsToCleanup</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nx">card</span><span class="p">.</span><span class="nx">onCleanup</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Clean up cards in play.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="vi">@current.inPlay = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Put duration cards by default in the duration area, and other cards
in play in the discard pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isDuration</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Discard the remaining cards in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.discard = </span><span class="nx">@current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@current</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
    <span class="vi">@current.hand = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Reset things for the next turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@current.actions = </span><span class="mi">1</span>
    <span class="vi">@current.buys = </span><span class="mi">1</span>
    <span class="vi">@current.coins = </span><span class="mi">0</span>
    <span class="vi">@current.potions = </span><span class="mi">0</span>
    <span class="vi">@current.actionsPlayed = </span><span class="mi">0</span>
    <span class="vi">@copperValue = </span><span class="mi">1</span>

    <span class="vi">@costModifiers = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Announce extra turn</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@extraturn</span>       
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{@current.ai} takes an extra turn from Outpost.&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Finally, draw the next hand of three/five cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Outpost</span> <span class="k">in</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@current</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Make sure we didn't drop cards on the floor.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">countTotalCards</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">@totalCards</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;The game started with #{@totalCards} cards; now there are #{this.countTotalCards()}&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>The player list is implemented so that the current player is always first
in the list; the list rotates after every turn.</p>

<p>For convenience, the attribute <code>@current</code> always points to the current
player.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rotatePlayer: </span><span class="nf">() -&gt;</span>
    <span class="vi">@players = </span><span class="nx">@players</span><span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">@nPlayers</span><span class="p">].</span><span class="nx">concat</span> <span class="p">[</span><span class="nx">@players</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="vi">@current = </span><span class="nx">@players</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="vi">@phase = </span><span class="s1">&#39;start&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <h3>Small-scale effects</h3>

<p><code>gainCard</code> performs the effects of a player gaining a card.</p>

<p>This is one of many events that affects a particular player, and
also has some effect on the overall state (in that the supply is
decreased). In this function and others like it, the <code>player</code> argument
is the appropriate PlayerState object to affect. This must, of course,
be one of the objects in the <code>@players</code> array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainCard: </span><span class="nf">(player, card, gainLocation=&#39;discard&#39;, suppressMessage=false) -&gt;</span>
    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">depth</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">delete</span> <span class="nx">@cache</span><span class="p">.</span><span class="nx">gainsToEndGame</span>
    <span class="k">if</span> <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">@specialSupply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">reactCard = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">reactCard</span><span class="o">?</span> <span class="o">and</span> <span class="nx">reactCard</span><span class="p">.</span><span class="nx">isReaction</span> <span class="o">and</span> <span class="nx">reactCard</span><span class="p">.</span><span class="nx">reactReplacingGain</span><span class="o">?</span>
          <span class="nv">card = </span><span class="nx">reactCard</span><span class="p">.</span><span class="nx">reactReplacingGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Keep track of the card gained, for Smugglers.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">player</span> <span class="o">is</span> <span class="nx">@current</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">gainedThisTurn</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p><code>suppressMessage</code> is true when this happens as the direct result of a
buy. Nobody wants to read "X buys Y. X gains Y." all the time.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">suppressMessage</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} gains #{card}.&quot;</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Determine what list the card is being gained in, and add it to the
front of that list.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">location = </span><span class="nx">player</span><span class="p">[</span><span class="nx">gainLocation</span><span class="p">]</span>
      <span class="nx">location</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Remove the card from the supply</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">@supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="nv">gainSource = </span><span class="s1">&#39;supply&#39;</span>
      <span class="k">else</span>
        <span class="nx">@specialSupply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="nv">gainSource = </span><span class="s1">&#39;specialSupply&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Delegate to <code>handleGainCard</code> to deal with reactions.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">handleGainCard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">gainLocation</span><span class="p">,</span> <span class="nx">gainSource</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;There is no #{card} to gain.&quot;</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p><code>handleGainCard</code> deals with the reactions that result from gaining a card.
A card effect such as Thief needs to call this explicitly after gaining a
card from someplace that is not the supply or the prize list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handleGainCard: </span><span class="nf">(player, card, gainLocation=&#39;discard&#39;, gainSource=&#39;supply&#39;) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Remember where the card was gained, so that reactions can find it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">player.gainLocation = </span><span class="nx">gainLocation</span>

    <span class="k">for</span> <span class="nx">own</span> <span class="nx">supplyCard</span><span class="p">,</span> <span class="nx">quantity</span> <span class="k">of</span> <span class="nx">@supply</span>
      <span class="nx">c</span><span class="p">[</span><span class="nx">supplyCard</span><span class="p">].</span><span class="nx">globalGainEffect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">gainSource</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">own</span> <span class="nx">supplyCard</span><span class="p">,</span> <span class="nx">quantity</span> <span class="k">of</span> <span class="nx">@specialSupply</span>
      <span class="nx">c</span><span class="p">[</span><span class="nx">supplyCard</span><span class="p">].</span><span class="nx">globalGainEffect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">gainSource</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Handle cards such as Royal Seal that respond to gains while they are
in play.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">cardInPlay = </span><span class="nx">player</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nx">cardInPlay</span><span class="p">.</span><span class="nx">gainInPlayEffect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Handle cards such as Watchtower that react to gains as a Reaction card.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">reactCard = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">reactCard</span><span class="p">.</span><span class="nx">isReaction</span>
        <span class="nx">reactCard</span><span class="p">.</span><span class="nx">reactToGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="nx">opp</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">reactCard = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">reactCard</span><span class="p">.</span><span class="nx">isReaction</span>
          <span class="nx">reactCard</span><span class="p">.</span><span class="nx">reactToOpponentGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opp</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Handle the card's own effects of being gained.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">card</span><span class="p">.</span><span class="nx">onGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span>      
  </pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Effects of an action could cause players to reveal their hand.
So far, nothing happens as a result, but in the future, AIs might
be able to take advantage of the information.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">revealHand: </span><span class="nf">(player) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} reveals the hand (#{player.hand}).&quot;</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p><code>drawCards</code> causes the player to draw <code>num</code> cards.</p>

<p>This currently passes through directly to the PlayerState, without
passing any information from the global state.
An improved version would pass the state in case the player shuffles,
and has Stash in the deck, and wants to use information from the state
to decide where to put the Stash.</p>

<p>The drawn cards will be returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawCards: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p><code>discardFromDeck</code> puts <em>num</em> cards from the top of the deck directly
in the discard pile. It returns the set of cards, for the benefit of
actions that do something based on which cards were discarded.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">discardFromDeck: </span><span class="nf">(player, nCards) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">player</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">nCards</span><span class="p">)</span>
    <span class="nv">player.discard = </span><span class="nx">player</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} draws and discards #{drawn.length} cards (#{drawn}).&quot;</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">drawn</span>
  </pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p><code>doDiscard</code> causes the player to discard a particular card.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doDiscard: </span><span class="nf">(player, card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{player.ai} has no #{card} to discard&quot;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} discards #{card}.&quot;</span><span class="p">)</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">])</span>
  </pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p><code>handleDiscards</code> looks through a list of cards and triggers their discard
reactions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handleDiscards: </span><span class="nf">(player, cards) -&gt;</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">cards</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isReaction</span>
        <span class="nx">card</span><span class="p">.</span><span class="nx">reactToDiscard</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p><code>doTrash</code> causes the player to trash a particular card.</p>

<p>For bookkeeping,
it puts it in the <code>@trash</code> list; if we start using <code>@trash</code> consistently,
we can count the total number of cards in the game, making sure that it's
constant and cards aren't being dropped on the floor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doTrash: </span><span class="nf">(player, card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{player.ai} has no #{card} to trash&quot;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} trashes #{card}.&quot;</span><span class="p">)</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">@trash</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p><code>doPutOnDeck</code> puts a particular card from the player's hand on top of
the player's draw pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doPutOnDeck: </span><span class="nf">(player, card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;#{player.ai} has no #{card} to put on deck.&quot;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} puts #{card} on deck.&quot;</span><span class="p">)</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p><code>getCardsFromDeck</code> is superficially similar to <code>drawCards</code>, but it does
not put the cards into the hand. Any code that calls it needs to determine
what happens to those cards (otherwise they'll be dropped on the floor!)</p>

<p>This is useful
for effects that say "draw <em>n</em> cards, do something based on them, and
discard them".</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCardsFromDeck: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p><code>allowDiscard</code> allows a player to discard 0 through <code>num</code> cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allowDiscard: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">discarded = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>In <code>allowDiscard</code>, valid discards are the entire hand, plus <code>null</code>
to stop discarding.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">validDiscards = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">validDiscards</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseDiscard</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validDiscards</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">discarded</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="nx">discarded</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">discarded</span>
  </pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p><code>requireDiscard</code> requires the player to discard exactly <code>num</code> cards,
except that it stops if the player has 0 cards in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">requireDiscard: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">discarded = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span>
      <span class="nv">validDiscards = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">discarded</span> <span class="k">if</span> <span class="nx">validDiscards</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseDiscard</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">validDiscards</span><span class="p">)</span>
      <span class="nx">discarded</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">discarded</span>
  </pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p><code>allowTrash</code> and <code>requireTrash</code> are similar to <code>allowDiscard</code> and
<code>requireDiscard</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allowTrash: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">trashed = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span>
      <span class="nv">valid = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">valid</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseTrash</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">valid</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">trashed</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="nx">trashed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">trashed</span>
  
  <span class="nv">requireTrash: </span><span class="nf">(player, num) -&gt;</span>
    <span class="nv">trashed = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">num</span>
      <span class="nv">valid = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">trashed</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseTrash</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">valid</span><span class="p">)</span>
      <span class="nx">trashed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">choice</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">trashed</span>
  </pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p><code>gainOneOf</code> gives the player a choice of cards to gain. Include
<code>null</code> if gaining nothing is an option.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainOneOf: </span><span class="nf">(player, options, location=&#39;discard&#39;) -&gt;</span>
    <span class="nv">choice = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseGain</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="kc">null</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">choice</span><span class="p">,</span> <span class="nx">location</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">choice</span>
  </pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p><code>attackOpponents</code> takes in a function of one argument, and applies
it to all players except the one whose turn it is.</p>

<p>The function should take in the PlayerState of the player to attack,
and alter it somehow. This function can also involve the global state:
it doesn't need to be passed in because it's already in scope in the place
where the action is defined. See <code>Militia</code> in <code>cards.coffee</code> for an
example.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attackOpponents: </span><span class="nf">(effect) -&gt;</span>
    <span class="k">for</span> <span class="nx">opp</span> <span class="k">in</span> <span class="nx">@players</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">attackPlayer</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">effect</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p><code>attackPlayer</code> does the work of attacking a particular player, including
handling their reactions to attacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attackPlayer: </span><span class="nf">(player, effect) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>attackEvent gets passed to each reactToAttack method.  Any card
may block the attack by setting attackEvent.blocked to true</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">attackEvent = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>Reaction cards in the hand can react to the attack</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">reactionCards = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span> <span class="k">when</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isReaction</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">reactionCards</span>
      <span class="nx">card</span><span class="p">.</span><span class="nx">reactToAttack</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">attackEvent</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">player</span><span class="p">.</span><span class="nx">duration</span>
      <span class="nx">card</span><span class="p">.</span><span class="nx">durationReactToAttack</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">attackEvent</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>Apply the attack's effect unless it's been blocked by a card such as
Moat or Lighthouse</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">effect</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">attackEvent</span><span class="p">.</span><span class="nx">blocked</span>
  </pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <h3>Bookkeeping</h3>

<p><code>copy()</code> makes a copy of this state that can be safely mutated
without affecting the original state.</p>

<p>Ideally, the AI would be passed a copy of the state, with unknown
information randomized, when it is asked to make a decision. This would
allow it to try simulating the effects of various plays without actually
breaking the game. But this isn't implemented yet, so make this a TODO.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">copy: </span><span class="nf">() -&gt;</span>
    <span class="nv">newSupply = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@supply</span>
      <span class="nx">newSupply</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    
    <span class="nv">newSpecialSupply = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@specialSupply</span>
      <span class="nx">newSpecialSupply</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nv">newState = </span><span class="k">new</span> <span class="nx">State</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>If something overrode the log function, make sure that's preserved.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">newState.logFunc = </span><span class="nx">@logFunc</span>

    <span class="nv">newPlayers = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">@players</span>
      <span class="nv">playerCopy = </span><span class="nx">player</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nv">playerCopy.logFunc = </span><span class="nf">(obj) -&gt;</span>
      <span class="nx">newPlayers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">playerCopy</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>Copy card-specific state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">newCardState = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">state</span> <span class="k">of</span> <span class="nx">@cardState</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>If the card state has a copy method, call it, otherwise just shallow
copy the state</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">copy</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>Objects with a copy method</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">newCardState</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">copy</span><span class="o">?</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">state</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>Objects with no copy method</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">newCardState</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">=</span> <span class="nv">copy = </span><span class="p">{}</span>
        <span class="nx">copy</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">state</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>Simple types</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">newCardState</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span>
    
    <span class="nv">newState.players = </span><span class="nx">newPlayers</span>
    <span class="nv">newState.supply = </span><span class="nx">newSupply</span>
    <span class="nv">newState.specialSupply = </span><span class="nx">newSpecialSupply</span>
    <span class="nv">newState.cardState = </span><span class="nx">newCardState</span>
    <span class="nv">newState.trash = </span><span class="nx">@trash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nv">newState.current = </span><span class="nx">newPlayers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">newState.nPlayers = </span><span class="nx">@nPlayers</span>
    <span class="nv">newState.costModifiers = </span><span class="nx">@costModifiers</span><span class="p">.</span><span class="nx">concat</span><span class="p">()</span>
    <span class="nv">newState.copperValue = </span><span class="nx">@copperValue</span>
    <span class="nv">newState.phase = </span><span class="nx">@phase</span>
    <span class="nv">newState.cache = </span><span class="p">{}</span>

    <span class="nx">newState</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p><code>hypothetical(ai)</code> returns a State and PlayerState that an AI can do
whatever it wants to without affecting the real state:</p>

<ul>
<li>Modifying the state will not affect the game (it is a copy, after all).</li>
<li>The hidden information in the state is randomized.</li>
<li>All the other AIs will be replaced by copies of the given AI.</li>
</ul>

<p>An AI that wants to test a hypothesis should do this:
  [state, my] = state.hypothetical(this)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hypothetical: </span><span class="nf">(ai) -&gt;</span>
    <span class="nv">state = </span><span class="k">this</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>Rotate through players until this AI is the current player.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">counter = </span><span class="mi">0</span>
    <span class="k">while</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">ai</span> <span class="o">isnt</span> <span class="nx">ai</span>
      <span class="nx">counter</span><span class="o">++</span>
      <span class="k">if</span> <span class="nx">counter</span> <span class="o">&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">nPlayers</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find this AI in the player list&quot;</span><span class="p">)</span>
      <span class="nv">state.players = </span><span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">...].</span><span class="nx">concat</span><span class="p">([</span><span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="nv">state.depth = </span><span class="k">this</span><span class="p">.</span><span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">my = </span><span class="kc">null</span>
    <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span>
      <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span> <span class="o">isnt</span> <span class="nx">ai</span>
        <span class="nv">player.ai = </span><span class="nx">ai</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>We don't know what's in their hand or their deck, so shuffle them
together randomly, preserving the number of cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">handSize = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">combined = </span><span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="nx">shuffle</span><span class="p">(</span><span class="nx">combined</span><span class="p">)</span>
        <span class="nv">player.hand = </span><span class="nx">combined</span><span class="p">[...</span><span class="nx">handSize</span><span class="p">]</span>
        <span class="nv">player.draw = </span><span class="nx">combined</span><span class="p">[</span><span class="nx">handSize</span><span class="p">...]</span>
      <span class="k">else</span>
        <span class="nx">shuffle</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="nv">my = </span><span class="nx">player</span>

    <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">my</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>Functions for comparing, used for sorting</p>

<p>Rob says: this is pretty AI-specific. It's also an unnecessarily complex operation,
even given caching. The choices are already in order in the actionPriority; they need
to be filtered, not sorted.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compareByActionPriority: </span><span class="nf">(state, my, x, y) -&gt;</span>
    <span class="nx">my</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">cacheActionPriority</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="nx">my</span><span class="p">)</span>
    <span class="nx">my</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choiceToValue</span><span class="p">(</span><span class="s1">&#39;cachedAction&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-</span> <span class="nx">my</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choiceToValue</span><span class="p">(</span><span class="s1">&#39;cachedAction&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
    
  <span class="nv">compareByCoinCost: </span><span class="nf">(state, my, x, y) -&gt;</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">y</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Games can provide output using the <code>log</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">log: </span><span class="nf">(obj) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Only log things that actually happen.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@depth</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="o">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">logFunc</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="k">else</span> 
        <span class="k">if</span> <span class="nx">console</span><span class="o">?</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>A warning has a similar effect to a log message, but indicates that
something has gone wrong with the gameplay.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">warn: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="nx">console</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;WARNING: &quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>Define some possible tableaux to play the game with. None of these are
actually legal tableaux, but that gives strategies more room to play.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nv">tableaux = </span><span class="p">{</span>
  <span class="nv">moneyOnly: </span><span class="p">[]</span>
  <span class="nv">moneyOnlyColony: </span><span class="p">[</span><span class="s1">&#39;Platinum&#39;</span><span class="p">,</span> <span class="s1">&#39;Colony&#39;</span><span class="p">]</span>
  <span class="nv">all: </span><span class="nx">c</span><span class="p">.</span><span class="nx">allCards</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>How to remove something from a JavaScript array. Modifies the list and
returns the 0 or 1 removed elements.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Array</span><span class="p">.</span><span class="nv">prototype.remove = </span><span class="nf">(elt) -&gt;</span>
  <span class="nv">idx = </span><span class="k">this</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">elt</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>Define the additional tableau of everything but Platinum/Colony.
If there's a better way to remove items from a JS array, I'd like to know
what it is.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">noColony = </span><span class="k">this</span><span class="p">.</span><span class="nx">tableaux</span><span class="p">.</span><span class="nx">all</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nx">noColony</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;Platinum&#39;</span><span class="p">)</span>
<span class="nx">noColony</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;Colony&#39;</span><span class="p">)</span>
<span class="k">this</span><span class="p">.</span><span class="nv">tableaux.noColony = </span><span class="nx">noColony</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <h2>Utility functions</h2>

<p>This customized clone function will not make unnecessary copies of
cards and AIs. However, it doesn't seem to work.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cloneDominionObject = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">obj</span><span class="o">?</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">isnt</span> <span class="s1">&#39;object&#39;</span>
    <span class="k">return</span> <span class="nx">obj</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">gainPriority</span><span class="o">?</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">costInCoins</span><span class="o">?</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">obj</span>
  <span class="nv">newInstance = </span><span class="k">new</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="nx">newInstance</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cloneDominionObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="nx">newInstance</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>General function to randomly shuffle a list.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">shuffle = </span><span class="nf">(v) -&gt;</span>
  <span class="nv">i = </span><span class="nx">v</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">while</span> <span class="nx">i</span>
    <span class="nv">j = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)</span>
    <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="nv">temp = </span><span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
    <span class="nx">v</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">temp</span>
  <span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Count the number of times a value appears in a list, coercing everything
to its string value.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">countStr = </span><span class="nf">(list, elt) -&gt;</span>
  <span class="nv">count = </span><span class="mi">0</span>
  <span class="k">for</span> <span class="nx">member</span> <span class="k">in</span> <span class="nx">list</span>
    <span class="k">if</span> <span class="nx">member</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="nx">elt</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nx">count</span><span class="o">++</span>
  <span class="nx">count</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>Sort by numeric value. You'd think this would be in the standard library.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">numericSort = </span><span class="nf">(array) -&gt;</span>
  <span class="nx">array</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="nf">(a, b) -&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="o">-</span><span class="nx">b</span><span class="p">)</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p>When modifying built-in methods of core types, we need to play nice with
other libraries.  For instance, our Array#toString method modifies the
behavior in a way that breaks the CoffeeScript compiler.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p>Modifies built-in methods of core Javascript types in a way that's reversible</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">modifyCoreTypes = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p>Make Array#toString output more readable</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">Array</span><span class="o">::</span><span class="nx">_originalToString</span> <span class="o">||=</span> <span class="nb">Array</span><span class="o">::</span><span class="nx">toString</span>
  <span class="nb">Array</span><span class="o">::</span><span class="nv">toString = </span><span class="o">-&gt;</span>
    <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>Reverses modifications to core Javascript types</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">restoreCoreTypes = </span><span class="o">-&gt;</span>
  <span class="nb">Array</span><span class="o">::</span><span class="nv">toString = </span><span class="nb">Array</span><span class="o">::</span><span class="nx">_originalToString</span> <span class="k">if</span> <span class="nb">Array</span><span class="o">::</span><span class="nx">_originalToString</span><span class="o">?</span>
  <span class="k">delete</span> <span class="nb">Array</span><span class="o">::</span><span class="nx">_originalToString</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>useCoreTypeMods takes an object and the name of a method.  It then wraps
that method so that it correctly uses and restores our core type
modifications.  The modifications are visible within the method body and
any child method calls, but they are cleaned up when leaving the method</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">useCoreTypeMods = </span><span class="nf">(object, method) -&gt;</span>
  <span class="nv">originalMethod = </span><span class="s2">&quot;_original_#{method}&quot;</span>
  <span class="nx">unless</span> <span class="nx">object</span><span class="p">[</span><span class="nx">originalMethod</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">object</span><span class="p">[</span><span class="nx">originalMethod</span><span class="p">]</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span>
    <span class="nx">object</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
      <span class="k">try</span>
        <span class="nx">modifyCoreTypes</span><span class="p">()</span>
        <span class="k">this</span><span class="p">[</span><span class="nx">originalMethod</span><span class="p">](</span><span class="nx">arguments</span><span class="p">...)</span>
      <span class="k">finally</span>
        <span class="nx">restoreCoreTypes</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <p>Use our core type modifications within the State object.  These three
methods are the ones called by external functions to set up and play
a game.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">useCoreTypeMods</span><span class="p">(</span><span class="nx">State</span><span class="o">::</span><span class="p">,</span> <span class="s1">&#39;setUpWithOptions&#39;</span><span class="p">)</span>
<span class="nx">useCoreTypeMods</span><span class="p">(</span><span class="nx">State</span><span class="o">::</span><span class="p">,</span> <span class="s1">&#39;gameIsOver&#39;</span><span class="p">)</span>
<span class="nx">useCoreTypeMods</span><span class="p">(</span><span class="nx">State</span><span class="o">::</span><span class="p">,</span> <span class="s1">&#39;doPlay&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <h2>Exports</h2>

<p>Export the State and PlayerState classes for other modules to use.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nv">State = </span><span class="nx">State</span>
<span class="k">this</span><span class="p">.</span><span class="nv">PlayerState = </span><span class="nx">PlayerState</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <h2>Indecisive imports</h2>

<p>Recall that this code begins with:</p>

<pre><code>{c} = require './cards' if exports?
</code></pre>

<p>This means "get the variable named <code>c</code> from the module <code>./cards</code>. Unless
there's no module system. In that case, don't."</p>

<p>Here's why that is useful. When the code
is running inside node.js, it will use node.js's import system. This
uses the predefined function <code>require</code>, which doesn't exist in a 
Web browser's JS environment.</p>

<p>When running in a web browser, there is no sane way for one module to
import another. Instead,
the typical practice -- which we will use too -- is to just load a bunch of
JavaScript files into the same global namespace.</p>

<p>In that case, the variable <code>c</code> already exists without any additional effort
from us. We're polluting the global namespace and defeating some of the
point of modules, but that's how most JavaScript in the wild works anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 