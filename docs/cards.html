<!DOCTYPE html>  <html> <head>   <title>cards.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="basicAI.html">                 basicAI.coffee               </a>                                           <a class="source" href="cards.html">                 cards.coffee               </a>                                           <a class="source" href="compileStrategies.html">                 compileStrategies.coffee               </a>                                           <a class="source" href="gameState.html">                 gameState.coffee               </a>                                           <a class="source" href="heuristics.html">                 heuristics.coffee               </a>                                           <a class="source" href="play.html">                 play.coffee               </a>                                           <a class="source" href="playWeb.html">                 playWeb.coffee               </a>                                           <a class="source" href="testSimulation.html">                 testSimulation.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               cards.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Dominion cards and their effects are defined in this file.  Each card is a
singleton, immutable object.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>We begin by creating the <code>c</code> object, an exported object with which one can 
look up any card by its name.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">c = </span><span class="p">{}</span>
<span class="k">this</span><span class="p">.</span><span class="nv">c = </span><span class="nx">c</span>
<span class="nv">c.allCards = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Defining cards</h2>

<p>Many cards are defined in terms of other cards using a pattern similar to
inheritance, except without the classes. There is no need for classes because
there are no separate instances.
Each Copper is a reference to the same single Copper object, for example.</p>

<p>The <code>makeCard</code> function will define a new card and add it to the card list.
<code>makeCard</code> works by copying an existing card object and applying a few new
properties to it.</p>

<p><code>name</code> is the name of the card, which will be the card's string
representation and the key that you look it up in the card list <code>c</code> by.</p>

<p>To define a card independently of any existing card, let <code>origCard</code> be the
abstract card called <code>basicCard</code>. To define a card in terms of another card,
let <code>origCard</code> be that card object (probably a member of <code>c</code>, such as
<code>c.Estate</code>).</p>

<p><code>props</code> are the properties of the card that differ from its parent.</p>

<p><code>fake</code> is true when this should be an abstract card, not a card in the
supply. Fake cards are simply returned, not added to <code>c</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">makeCard = </span><span class="nf">(name, origCard, props, fake) -&gt;</span>
  <span class="nv">newCard = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">origCard</span>
    <span class="nx">newCard</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  <span class="nv">newCard.name = </span><span class="nx">name</span>
  <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">props</span>
    <span class="nx">newCard</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  <span class="nv">newCard.parent = </span><span class="nx">origCard</span><span class="p">.</span><span class="nx">name</span>   <span class="c1"># for debugging</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">fake</span>
    <span class="nx">c</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newCard</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">allCards</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
  <span class="nx">newCard</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>The basicCard object</h3>

<p><code>basicCard</code> contains all the things that are true by default
about a card, plus many useful methods that will be available on all cards.
All other cards should have <code>basicCard</code> as an ancestor. Many of the
properties and methods of <code>basicCard</code> are meant to be overridden in
real cards.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">basicCard = </span><span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>This set of boolean values defines a card's types. Cards may have any
number of types.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isAction: </span><span class="kc">false</span>
  <span class="nv">isTreasure: </span><span class="kc">false</span>
  <span class="nv">isVictory: </span><span class="kc">false</span>
  <span class="nv">isAttack: </span><span class="kc">false</span>
  <span class="nv">isReaction: </span><span class="kc">false</span>
  <span class="nv">isDuration: </span><span class="kc">false</span>
  <span class="nv">isPrize: </span><span class="kc">false</span>
  <span class="nv">isMultiplier: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The <strong>base cost</strong> of a card is defined here. To find out what a card
<em>actually</em> costs, use the getCost() method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cost: </span><span class="mi">0</span>
  <span class="nv">costPotion: </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>These methods may be overridden by cards whose costs vary on their own,
particularly Peddler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">costInCoins: </span><span class="nf">(state) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cost</span>
  <span class="nv">costInPotions: </span><span class="nf">(state) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">costPotion</span>
  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Card costs can change according to things external to the card, such as
bridges and quarries in play. Therefore, any code that wants to know the
actual cost of a card in a state should call <code>card.getCost(state)</code>.</p>

<p>This method returns a list of two elements, which are the cost in
coins and the cost in potions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCost: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">coins = </span><span class="k">this</span><span class="p">.</span><span class="nx">costInCoins</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nx">coins</span> <span class="o">-=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">bridges</span>
    <span class="nx">coins</span> <span class="o">-=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">highways</span>
    <span class="nx">coins</span> <span class="o">-=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">princesses</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">isAction</span>
      <span class="nx">coins</span> <span class="o">-=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">quarries</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="nx">coins</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">coins = </span><span class="mi">0</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">costInPotions</span><span class="p">(</span><span class="nx">state</span><span class="p">)]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>These properties define simple, non-variable effects of playing a card.
They may only have constant numeric values.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">actions: </span><span class="mi">0</span>
  <span class="nv">cards: </span><span class="mi">0</span>
  <span class="nv">coins: </span><span class="mi">0</span>
  <span class="nv">buys: </span><span class="mi">0</span>
  <span class="nv">vp: </span><span class="mi">0</span>
  <span class="nv">trash: </span><span class="mi">0</span>        <span class="c1"># if the card requires trashing for no further effect</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>If a card has simple effects that <em>vary</em> based on the state, define
them by overriding these methods, which do take the state as a parameter.
The constant properties above will be ignored in that case, but you could
fill them in with reasonable guesses for the benefit of AI methods that
don't want to examine the state.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getActions: </span><span class="nf">(state) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span>
  <span class="nv">getCards: </span><span class="nf">(state) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cards</span>
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">coins</span>
  <span class="nv">getBuys: </span><span class="nf">(state) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">buys</span>
  <span class="nv">getTrash: </span><span class="nf">(state) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">trash</span>
  <span class="nv">getVP: </span><span class="nf">(player) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">vp</span>
  </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>getPotion says whether the card provides a potion. There is only one
card for which this is true, which is Potion.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getPotion: </span><span class="nf">(state) -&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Some cards (Grand Market) may not be bought in certain situations.
Use <code>cards.mayBeBought(state)</code> to define when. By default, a card may be
bought whenever it is in the supply.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mayBeBought: </span><span class="nf">(state) -&gt;</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><code>card.startingSupply(state)</code> is called once for each card in the supply
at the start of the game, to determine how many of them go into the supply.
This is 10 by default, but some types of cards override it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>Complex effects</h3>

<p>More complex effects of a card can be defined using arbitrary functions
that modify the state. These functions are no-ops in <code>basicCard</code>, and
may be overridden by cards that need them:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <ul>
<li>What happens when the card is bought?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buyEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <ul>
<li>What happens when the card is gained?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <ul>
<li>What happens (besides the simple effects defined above) when the card is
played?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <ul>
<li>What happens when this card is in play and another card is gained?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainInPlayEffect: </span><span class="nf">(state, card) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <ul>
<li>What happens when this card is in play and another card is specifically
bought?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buyInPlayEffect: </span><span class="nf">(state, card) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <ul>
<li>What happens when this card is cleaned up from play?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cleanupEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <ul>
<li>What happens when the card is in play as a Duration at the start of
the turn?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">durationEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <ul>
<li>What happens when the card is shuffled into the draw deck?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shuffleEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <ul>
<li>What happens when this card is in hand and an opponent plays an attack?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reactToAttack: </span><span class="nf">(state, player) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <ul>
<li>What happens when this card is in hand and its owner gains a card?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reactToGain: </span><span class="nf">(state, player, card) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <ul>
<li>What happens when this card is in hand and someone else gains a card?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reactToOpponentGain: </span><span class="nf">(state, player, opponent, card) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <ul>
<li>What happens when this card is discarded?</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reactToDiscard: </span><span class="nf">(state, player) -&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>This defines everything that happens when a card is played, including
basic effects and complex effects defined in <code>playEffect</code>. Cards
should not override <code>onPlay</code>; they should override <code>playEffect</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onPlay: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActions</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCoins</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">potions</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPotion</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">buys</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getBuys</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nv">cardsToDraw = </span><span class="k">this</span><span class="p">.</span><span class="nx">getCards</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nv">cardsToTrash = </span><span class="k">this</span><span class="p">.</span><span class="nx">getTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">cardsToDraw</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">cardsToDraw</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">cardsToTrash</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">requireTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">cardsToTrash</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">playEffect</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Similarly, these are other ways for the game state to interact
with the card. Cards should override the <code>Effect</code> methods, not these.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onDuration: </span><span class="nf">(state) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">durationEffect</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
  
  <span class="nv">onCleanup: </span><span class="nf">(state) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cleanupEffect</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>

  <span class="nv">onBuy: </span><span class="nf">(state) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buyEffect</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
  
  <span class="nv">onGain: </span><span class="nf">(state, player) -&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gainEffect</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>A card's string representation is its name.</p>

<p>If you have a value called
<code>card</code> that may be a string or a card object, you can ensure that it is
a card object by looking up <code>c[card]</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toString: </span><span class="nf">() -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>Base cards</h2>

<p>These are the cards that are not Kingdom cards. Most of them appear in every
game; Potion, Platinum, and Colony appear in only some games.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Curse&#39;</span><span class="p">,</span> <span class="nx">basicCard</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Curse is the only card with no type.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cost: </span><span class="mi">0</span>
  <span class="nv">vp: </span><span class="o">-</span><span class="mi">1</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">nPlayers</span>
      <span class="k">when</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="k">then</span> <span class="mi">10</span>
      <span class="k">when</span> <span class="mi">3</span> <span class="k">then</span> <span class="mi">20</span>
      <span class="k">when</span> <span class="mi">4</span> <span class="k">then</span> <span class="mi">30</span>
      <span class="k">when</span> <span class="mi">5</span> <span class="k">then</span> <span class="mi">40</span>
      <span class="k">else</span> <span class="mi">50</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>To define victory cards, we define Estate and then derive other cards from
it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Estate&#39;</span><span class="p">,</span> <span class="nx">basicCard</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">isVictory: </span><span class="kc">true</span>
  <span class="nv">vp: </span><span class="mi">1</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">nPlayers</span>
      <span class="k">when</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="k">then</span> <span class="mi">8</span>
      <span class="k">else</span> <span class="mi">12</span> 
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Duchy&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span><span class="p">,</span> <span class="nv">vp: </span><span class="mi">3</span><span class="p">,</span>
  </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>If Duchess is in the game, the player has the option of gaining it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gainEffect: </span><span class="nf">(state, player) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="s1">&#39;Duchess&#39;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Duchess</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
<span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Province&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">8</span>
  <span class="nv">vp: </span><span class="mi">6</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">nPlayers</span>
      <span class="k">when</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="k">then</span> <span class="mi">8</span>
      <span class="k">when</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="k">then</span> <span class="mi">12</span>
      <span class="k">when</span> <span class="mi">5</span> <span class="k">then</span> <span class="mi">15</span>
      <span class="k">else</span> <span class="mi">18</span>
<span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Colony&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span><span class="nv">cost: </span><span class="mi">11</span><span class="p">,</span> <span class="nv">vp: </span><span class="mi">10</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Now we define the basic treasure cards. Our prototypical card here is
Silver.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Silver&#39;</span><span class="p">,</span> <span class="nx">basicCard</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">isTreasure: </span><span class="kc">true</span>
  <span class="nv">coins: </span><span class="mi">2</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">40</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Copper is actually more complex than Silver: its value can vary when modified
by Coppersmith.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Copper&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">0</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">copperValue</span> <span class="o">?</span> <span class="mi">1</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">60</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Gold&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">coins: </span><span class="mi">3</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">30</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Platinum&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">9</span><span class="p">,</span>
  <span class="nv">coins: </span><span class="mi">5</span><span class="p">,</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">12</span>
<span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Potion&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Deleted playEffect. Potions where counted twice.
OnPlay() already increases @current.potions via getPotion(state)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getPotion: </span><span class="nf">(state) -&gt;</span> <span class="mi">1</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">16</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h2>Vanilla cards</h2>

<p>These cards have effects that involve no decisions, and are expressed entirely
in +actions, +cards, +coins, +buys, and VP.</p>

<p>Action cards may derive from the virtual card called <code>action</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">action = </span><span class="nx">makeCard</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="nx">basicCard</span><span class="p">,</span> <span class="p">{</span><span class="nv">isAction: </span><span class="kc">true</span><span class="p">},</span> <span class="kc">true</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Village&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span><span class="nv">cost: </span><span class="mi">3</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">cards: </span><span class="mi">1</span><span class="p">}</span>
<span class="nx">makeCard</span> <span class="s2">&quot;Worker&#39;s Village&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">actions: </span><span class="mi">2</span>
  <span class="nv">cards: </span><span class="mi">1</span>
  <span class="nv">buys: </span><span class="mi">1</span>
<span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Laboratory&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span><span class="nv">cost: </span><span class="mi">5</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">cards: </span><span class="mi">2</span><span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Smithy&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span><span class="nv">cost: </span><span class="mi">4</span><span class="p">,</span> <span class="nv">cards: </span><span class="mi">3</span><span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Festival&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span><span class="nv">cost: </span><span class="mi">5</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">buys: </span><span class="mi">1</span><span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Woodcutter&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span><span class="nv">cost: </span><span class="mi">3</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">buys: </span><span class="mi">1</span><span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Market&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">cards: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">buys: </span><span class="mi">1</span>
<span class="p">}</span>
<span class="nx">makeCard</span> <span class="s1">&#39;Bazaar&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">cards: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">1</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h2>Kingdom Victory cards</h2>

<p>These cards are all derived from Estate to insure their starting supply
amount is correct. This goes for multi-type Victory cards too--deriving Great Hall
from action instead of Estate results in 10 Great Halls in the supply instead of
8 for a 2-player game or 12 for more players.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Duke&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">getVP: </span><span class="nf">(player) -&gt;</span> <span class="nx">player</span><span class="p">.</span><span class="nx">countInDeck</span><span class="p">(</span><span class="s1">&#39;Duchy&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Fairgrounds&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">getVP: </span><span class="nf">(player) -&gt;</span>
    <span class="nv">unique = </span><span class="p">[]</span>
    <span class="nv">deck = </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">deck</span>
      <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">unique</span>
        <span class="nx">unique</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">unique</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ 5)    </span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Farmland&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">vp: </span><span class="mi">2</span>

  <span class="nv">upgradeFilter: </span><span class="nf">(state, oldCard, newCard) -&gt;</span>
    <span class="p">[</span><span class="nx">coins1</span><span class="p">,</span> <span class="nx">potions1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">coins2</span><span class="p">,</span> <span class="nx">potions2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">potions1</span> <span class="o">==</span> <span class="nx">potions2</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">coins1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="nx">coins2</span><span class="p">)</span>

  <span class="nv">buyEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="nx">upgradeChoices</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgradeFilter</span><span class="p">)</span>
    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="p">[</span><span class="nx">oldCard</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">]</span> <span class="o">=</span> <span class="nx">choice</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">oldCard</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">)</span>    
<span class="p">}</span>


<span class="nx">makeCard</span> <span class="s1">&#39;Gardens&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">getVP: </span><span class="nf">(player) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getDeck</span><span class="p">().</span><span class="nx">length</span> <span class="err">/ 10)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Great Hall&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">isAction: </span><span class="kc">true</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Harem&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">isTreasure: </span><span class="kc">true</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">coins: </span><span class="mi">2</span>
  <span class="nv">vp: </span><span class="mi">2</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Island&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">isAction: </span><span class="kc">true</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">vp: </span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># handle a weird edge case</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;…setting aside the Island (no other cards in hand).&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">card = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;island&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;…setting aside the Island and a #{card}.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">mats</span><span class="p">.</span><span class="nx">island</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>removing the Island from play is conditional so it won't break with 
Throne Room and King's Court</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="k">this</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">mats</span><span class="p">.</span><span class="nx">island</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Nobles&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">isAction: </span><span class="kc">true</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">vp: </span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Nobles is an example of a card that allows a choice from multiple
simple effects. We implement this using the <code>choose('benefit')</code> AI method,
which is passed a list of benefit objects, one of which it will choose
to apply to the state.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nv">benefit = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;benefit&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">{</span><span class="nv">actions: </span><span class="mi">2</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">cards: </span><span class="mi">3</span><span class="p">}</span>
      <span class="p">])</span>
      <span class="nx">applyBenefit</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Silk Road&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">getVP: </span><span class="nf">(player) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">countCardTypeInDeck</span><span class="p">(</span><span class="s1">&#39;Victory&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Revealing Tunnel for Gold as it is discarded is automatic.
TODO: make this into a decision.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Tunnel&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">isReaction: </span><span class="kc">true</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">vp: </span><span class="mi">2</span>

  <span class="nv">reactToDiscard: </span><span class="nf">(state, player) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">phase</span> <span class="o">isnt</span> <span class="s1">&#39;cleanup&#39;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} gains a Gold for discarding the Tunnel.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">)</span>
    
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Vineyard&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">0</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">getVP: </span><span class="nf">(player) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">numActionCardsInDeck</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h2>Kingdom Treasure cards</h2>

<p>Kingdom cards that are also treasure cards derive from treasure, which
derives from Silver, but with a changed startingSupply.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">treasure = </span><span class="nx">makeCard</span> <span class="s1">&#39;treasure&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="p">{</span><span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">10</span><span class="p">},</span> <span class="kc">true</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Bank&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">7</span>
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">coins = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nx">coins</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nx">coins</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...which is worth #{this.getCoins(state)}.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Cache&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="mi">3</span>
  
  <span class="nv">gainEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Fool&#39;s Gold&quot;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">isReaction: </span><span class="kc">true</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">foolsGoldInPlay</span>
      <span class="mi">4</span>
    <span class="k">else</span>
      <span class="mi">1</span>
  
  <span class="nv">reactToOpponentGain: </span><span class="nf">(state, player, opp, card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Province</span>
      <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;foolsGoldTrash&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="kc">yes</span><span class="p">,</span> <span class="kc">no</span><span class="p">])</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting the Gold on top of the draw pile.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Hoard&quot;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">buyInPlayEffect: </span><span class="nf">(state, card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...gaining a Gold.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Horn of Plenty&quot;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="mi">0</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span> 
    <span class="nv">limit = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">numUniqueCardsInPlay</span><span class="p">()</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">cardName</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">potions</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;=</span> <span class="nx">limit</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span><span class="p">.</span><span class="nx">isVictory</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} trashes the Horn of Plenty.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Ill-Gotten Gains&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span> 
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;gainCopper&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="kc">yes</span><span class="p">,</span> <span class="kc">no</span><span class="p">])</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">,</span> <span class="s1">&#39;hand&#39;</span><span class="p">)</span>
  
  <span class="nv">gainEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>For each player but the current: gain a curse.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">state</span><span class="p">.</span><span class="nx">nPlayers</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Loan&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
      <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
    <span class="p">)</span>    
    <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">treasure = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">trash = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;trash&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">treasure</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
      <span class="k">if</span> <span class="nx">trash</span><span class="o">?</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...trashing the #{treasure}.&quot;</span><span class="p">)</span>
        <span class="nx">transferCard</span><span class="p">(</span><span class="nx">treasure</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...discarding the #{treasure}.&quot;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="p">[</span><span class="nx">treasure</span><span class="p">])</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Philosopher&#39;s Stone&quot;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span>
    <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...which is worth #{this.getCoins(state)}.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Quarry&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">quarries</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Royal Seal&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">gainInPlayEffect: </span><span class="nf">(state, card) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">gainLocation</span> <span class="o">==</span> <span class="s1">&#39;trash&#39;</span>
    <span class="nv">source = </span><span class="nx">player</span><span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">gainLocation</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;gainOnDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting the #{card} on top of the deck.&quot;</span><span class="p">)</span>
      <span class="nv">player.gainLocation = </span><span class="s1">&#39;draw&#39;</span>
      <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Talisman&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">buyInPlayEffect: </span><span class="nf">(state, card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">card</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...gaining a #{card}.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Venture&#39;</span><span class="p">,</span> <span class="nx">treasure</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
      <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">treasure = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...playing #{treasure}.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
      <span class="nx">treasure</span><span class="p">.</span><span class="nx">onPlay</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h2>Duration cards</h2>

<p>These cards have additional properties, such as <code>durationActions</code>, defining
constant effects that happen when the card is resolved as a duration card.
The virtual card <code>duration</code> specifies how to process these effects.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">duration = </span><span class="nx">makeCard</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">durationActions: </span><span class="mi">0</span>
  <span class="nv">durationBuys: </span><span class="mi">0</span>
  <span class="nv">durationCoins: </span><span class="mi">0</span>
  <span class="nv">durationCards: </span><span class="mi">0</span>
  <span class="nv">isDuration: </span><span class="kc">true</span>

  <span class="nv">durationEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">durationActions</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">buys</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">durationBuys</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">durationCoins</span>
      <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">durationCards</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">durationCards</span><span class="p">)</span>
<span class="p">},</span> <span class="kc">true</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Haven&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">cardInHaven = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;putOnDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">cardInHaven</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} sets aside a #{cardInHaven} with Haven.&quot;</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">cardInHaven</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAsideByHaven</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} has no cards to set aside.&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;hand not empty but no card set aside&quot;</span><span class="p">)</span>
  
  <span class="nv">durationEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">cardFromHaven = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAsideByHaven</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">cardFromHaven</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} picks up a #{cardFromHaven} from Haven.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">cardFromHaven</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Caravan&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">durationCards: </span><span class="o">+</span><span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Fishing Village&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">durationActions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">durationCoins: </span><span class="o">+</span><span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Wharf&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">buys: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">durationCards: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">durationBuys: </span><span class="o">+</span><span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Merchant Ship&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">durationCoins: </span><span class="o">+</span><span class="mi">2</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Lighthouse&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">durationCoins: </span><span class="o">+</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>The protecting effect is defined in gameState.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Outpost&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>effect implemented by gameState</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span> 

<span class="nx">makeCard</span> <span class="s1">&#39;Tactician&#39;</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">durationActions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">durationBuys: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">durationCards: </span><span class="o">+</span><span class="mi">5</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">cardsInHand = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>If any cards can be discarded...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">cardsInHand</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Discard the hand and activate the tactician.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...discarding the whole hand.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">tacticians</span><span class="o">++</span>
      <span class="nv">discards = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
      <span class="nv">state.current.discard = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">discards</span><span class="p">)</span>
      <span class="nv">state.current.hand = </span><span class="p">[]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">discards</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>The cleanupEffect of a dead Tactician is to discard it instead of putting it in the
duration area. It's not a duration card in this case.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cleanupEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">tacticians</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">tacticians</span><span class="o">--</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} discards an inactive Tactician.&quot;</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Tactician</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">duration</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Tactician</span><span class="p">])</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h2>Trash-for-gain cards</h2>

<p>This section describes the actions where you trash one card to gain another.
I refer to this in general as "upgrading", which is not meant to be specific
to the card Upgrade.</p>

<p>The prototype on which we base these cards is Remodel. Most of the other
cards are variants that simply change the filter for which upgrades are
possible.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Remodel&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>

  <span class="nv">exactCostUpgrade: </span><span class="kc">false</span>
  <span class="nv">costFunction: </span><span class="nf">(coins) -&gt;</span> <span class="nx">coins</span> <span class="o">+</span> <span class="mi">2</span>

  <span class="nv">upgradeFilter: </span><span class="nf">(state, oldCard, newCard) -&gt;</span>
    <span class="p">[</span><span class="nx">coins1</span><span class="p">,</span> <span class="nx">potions1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">coins2</span><span class="p">,</span> <span class="nx">potions2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">exactCostUpgrade</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">potions1</span> <span class="o">&gt;=</span> <span class="nx">potions2</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">costFunction</span><span class="p">(</span><span class="nx">coins1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">coins2</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">potions1</span> <span class="o">&gt;=</span> <span class="nx">potions2</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">costFunction</span><span class="p">(</span><span class="nx">coins1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">coins2</span><span class="p">)</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="nx">upgradeChoices</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgradeFilter</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
    <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">exactCostUpgrade</span>
      <span class="nv">choices2 = </span><span class="nx">nullUpgradeChoices</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">costFunction</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
      <span class="nv">choices = </span><span class="nx">choices</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">choices2</span><span class="p">)</span>

    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="p">[</span><span class="nx">oldCard</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">]</span> <span class="o">=</span> <span class="nx">choice</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">oldCard</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">newCard</span> <span class="o">isnt</span> <span class="kc">null</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Expand&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Remodel</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">7</span>

  <span class="nv">costFunction: </span><span class="nf">(coins) -&gt;</span> <span class="nx">coins</span> <span class="o">+</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Upgrade&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Remodel</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">exactCostUpgrade: </span><span class="kc">true</span>
  <span class="nv">costFunction: </span><span class="nf">(coins) -&gt;</span> <span class="nx">coins</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Remake&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Remodel</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">exactCostUpgrade: </span><span class="kc">true</span>
  <span class="nv">costFunction: </span><span class="nf">(coins) -&gt;</span> <span class="nx">coins</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">2</span><span class="p">]</span>
      <span class="nv">choices = </span><span class="nx">upgradeChoices</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgradeFilter</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
      <span class="nv">choices2 = </span><span class="nx">nullUpgradeChoices</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">costFunction</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
      <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">choices2</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
        <span class="p">[</span><span class="nx">oldCard</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">]</span> <span class="o">=</span> <span class="nx">choice</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">oldCard</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">newCard</span> <span class="o">isnt</span> <span class="kc">null</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">)</span>  
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Mine&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Remodel</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>

  <span class="nv">upgradeFilter: </span><span class="nf">(state, oldCard, newCard) -&gt;</span>
    <span class="p">[</span><span class="nx">coins1</span><span class="p">,</span> <span class="nx">potions1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">coins2</span><span class="p">,</span> <span class="nx">potions2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">potions1</span> <span class="o">&gt;=</span> <span class="nx">potions2</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">coins1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="nx">coins2</span><span class="p">)</span> <span class="o">\</span>
       <span class="o">and</span> <span class="nx">oldCard</span><span class="p">.</span><span class="nx">isTreasure</span> <span class="o">and</span> <span class="nx">newCard</span><span class="p">.</span><span class="nx">isTreasure</span>
  </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Modify the Remodel playEffect so that it gains the card in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="nx">upgradeChoices</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgradeFilter</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="p">[</span><span class="nx">oldCard</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">]</span> <span class="o">=</span> <span class="nx">choice</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">oldCard</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">,</span> <span class="s1">&#39;hand&#39;</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <h2>Prize cards</h2>

<p>Because Prize cards can only be gained through Tournament, and all have
cost = 0, startingSupply -> 0, and mayBeBought -> false it is useful to
have a prototype prize. The prototype has isAction: true since 4 of the 5
prizes are action cards.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">prize = </span><span class="nx">makeCard</span> <span class="s1">&#39;prize&#39;</span><span class="p">,</span> <span class="nx">basicCard</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">0</span>
  <span class="nv">isPrize: </span><span class="kc">true</span>
  <span class="nv">isAction: </span><span class="kc">true</span>
  <span class="nv">mayBeBought: </span><span class="nf">(state) -&gt;</span> <span class="kc">false</span>
  <span class="nv">startingSupply: </span><span class="nf">(state) -&gt;</span> <span class="mi">0</span>
<span class="p">},</span> <span class="kc">true</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Bag of Gold&#39;</span><span class="p">,</span> <span class="nx">prize</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span> 
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting the Gold on top of the deck.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Diadem&#39;</span><span class="p">,</span> <span class="nx">prize</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">isAction: </span><span class="kc">false</span>
  <span class="nv">isTreasure: </span><span class="kc">true</span> 
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span> <span class="mi">2</span> <span class="o">+</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Followers&#39;</span><span class="p">,</span> <span class="nx">prize</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">isAttack: </span><span class="kc">true</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Since there is only one Princess card, and Princess's cost
reduction effect has the clause "while this is in play",
state.princesses will never need to be greater than 1.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Princess&#39;</span><span class="p">,</span> <span class="nx">prize</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">buys: </span><span class="mi">1</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nv">state.princesses = </span><span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Trusty Steed&#39;</span><span class="p">,</span> <span class="nx">prize</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">benefit = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;benefit&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span>
      <span class="p">{</span><span class="nv">cards: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">2</span><span class="p">},</span>
      <span class="p">{</span><span class="nv">cards: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">2</span><span class="p">},</span>
      <span class="p">{</span><span class="nv">actions: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">2</span><span class="p">},</span>
      <span class="p">{</span><span class="nv">cards: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">horseEffect: </span><span class="kc">yes</span><span class="p">},</span>
      <span class="p">{</span><span class="nv">actions: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">horseEffect: </span><span class="kc">yes</span><span class="p">},</span>
      <span class="p">{</span><span class="nv">coins: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">horseEffect: </span><span class="kc">yes</span><span class="p">}</span>
    <span class="p">])</span>
    <span class="nx">applyBenefit</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h2>Attack cards</h2>

<p>Cards with the type Attack; their prototype is just used so
isAttack: true doesn't need to be rewritten every time.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">attack = </span><span class="nx">makeCard</span> <span class="s1">&#39;attack&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span><span class="nv">isAttack: </span><span class="kc">true</span><span class="p">},</span> <span class="kc">true</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Ambassador&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Determine the cards and quantities that can be ambassadored</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">counts = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
      <span class="nx">counts</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">?=</span> <span class="mi">0</span>
      <span class="nx">counts</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">count</span> <span class="k">of</span> <span class="nx">counts</span>
      <span class="k">if</span> <span class="nx">count</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">count</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
      <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;ambassador&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="p">[</span><span class="nx">cardName</span><span class="p">,</span> <span class="nx">quantity</span><span class="p">]</span> <span class="o">=</span> <span class="nx">choice</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...choosing to return #{quantity} #{cardName}.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">quantity</span><span class="p">]</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Return it to the supply, if it had a slot in the supply to begin with</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">quantity</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...but #{cardName} is not in the Supply.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Bureaucrat&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nv">victory = </span><span class="p">[]</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="o">?</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">opp</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;#{opp} has no hand attribute&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span>
          <span class="nx">victory</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">victory</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">revealHand</span><span class="p">(</span><span class="nx">opp</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{opp.ai} reveals a hand with no Victory cards.&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">choice = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;putOnDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">victory</span><span class="p">)</span>
        <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">choice</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{opp.ai} returns #{choice} to the top of the deck.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Cutpurse&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span> <span class="k">in</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{opp.ai} has no Copper in hand.&quot;</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">revealHand</span><span class="p">(</span><span class="nx">opp</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Familiar&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Fortune Teller&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nv">drawn = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
        <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span> <span class="o">or</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span>
      <span class="p">)</span>
      <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">card = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} puts #{card} on top of the deck.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Ghost Ship&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="k">while</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Choosing cards one at a time does not necessarily lead to the
best decision. However, it leads to a reasonable, quick decision when
there could be a very large number of nearly-identical options
to evaluate, which is good for a simulator.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">choices = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span>
        <span class="nv">putBack = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;putOnDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} puts #{putBack} on top of the deck.&quot;</span><span class="p">)</span>
        <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">putBack</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Goons: <em>see Militia</em></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Jester&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nv">card = </span><span class="nx">state</span><span class="p">.</span><span class="nx">discardFromDeck</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">card</span><span class="o">?</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseGain</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Margrave&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">3</span>
  <span class="nv">buys: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Militia&quot;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Militia is a straightforward example of an attack card.</p>

<p>All attack effects are wrapped in the <code>state.attackOpponents</code>
method, to give opponents a chance to play reaction cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
        <span class="k">if</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Goons&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Militia</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">buys: </span><span class="o">+</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>The effect of Goons that causes you to gain VP on each buy is 
defined in <code>State.doBuyPhase</code>. Other than that, Goons is a fancy
Militia.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Mountebank&quot;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span> <span class="k">in</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Discarding a Curse against Mountebank is automatic.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">state</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Because attacking on buy does not count as playing an Attack, Noble Brigand's
buyEffect and playEffect cannot directly borrow from each other: the buyEffect
should not be blockable by Moat, so it cannot just call the playEffect, and
stat.attackOpponents needs an opp parameter, but buyEffect does not have an opp
parameter. So a third method is defined which takes both the state and opp as
parameters, and is accessed by both the buyEffect and the playEffect.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Noble Brigand&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">1</span>
  
  <span class="nv">buyEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">for</span> <span class="nx">opp</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">..]</span>
      <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Noble Brigand&#39;</span><span class="p">].</span><span class="nx">robTheRich</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">opp</span><span class="p">)</span>
    
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Noble Brigand&#39;</span><span class="p">].</span><span class="nx">robTheRich</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">opp</span><span class="p">)</span>
      
  <span class="nv">robTheRich: </span><span class="nf">(state, opp) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} reveals #{drawn}.&quot;</span><span class="p">)</span>
    <span class="nv">silversAndGolds = </span><span class="p">[]</span>
    <span class="nv">gainCopper = </span><span class="kc">true</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">drawn</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nv">gainCopper = </span><span class="kc">false</span>
        <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span> <span class="o">or</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span>
          <span class="nx">silversAndGolds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nv">treasureToTrash = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;trashOppTreasure&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">silversAndGolds</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">treasureToTrash</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} trashes #{opp.ai}&#39;s #{treasureToTrash}.&quot;</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">treasureToTrash</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">treasureToTrash</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleGainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">treasureToTrash</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} gains the trashed #{treasureToTrash}.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">gainCopper</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
    <span class="nv">opp.discard = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="p">[</span><span class="nx">drawn</span><span class="p">])</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} discards #{drawn}.&quot;</span><span class="p">)</span>     
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Oracle&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span>
    <span class="nv">myCards = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">oracleDiscardValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">myCards</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...discarding #{myCards}.&quot;</span><span class="p">)</span>
      <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">discard</span><span class="p">,</span> <span class="nx">myCards</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...keeping #{myCards} on top of the deck.&quot;</span><span class="p">)</span>
      <span class="nb">Array</span><span class="o">::</span><span class="nx">unshift</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">,</span> <span class="nx">myCards</span><span class="p">)</span>
    
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nv">cards = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Can't use oracleDiscardValue because it's a different situation, and
we don't know what's in the opponent's hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">value = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">cards</span>
        <span class="nx">value</span> <span class="o">+=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choiceToValue</span><span class="p">(</span><span class="s1">&#39;discardFromOpponentDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} discards #{cards} from #{opp.ai}&#39;s deck.&quot;</span><span class="p">)</span>
        <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">opp</span><span class="p">.</span><span class="nx">discard</span><span class="p">,</span> <span class="nx">cards</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} leaves #{cards} on #{opp.ai}&#39;s deck.&quot;</span><span class="p">)</span>
        <span class="nb">Array</span><span class="o">::</span><span class="nx">unshift</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">opp</span><span class="p">.</span><span class="nx">draw</span><span class="p">,</span> <span class="nx">cards</span><span class="p">)</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Pirate Ship&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;pirateShip&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;coins&#39;</span><span class="p">,</span><span class="s1">&#39;attack&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="s1">&#39;coins&#39;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">mats</span><span class="p">.</span><span class="nx">pirateShip</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...getting +$#{state.current.mats.pirateShip}.&quot;</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">choice</span> <span class="o">is</span> <span class="s1">&#39;attack&#39;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...attacking the other players.&quot;</span><span class="p">)</span>
      <span class="nv">attackSuccess = </span><span class="kc">false</span>

      <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
        <span class="nv">drawn = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} reveals #{drawn}.&quot;</span><span class="p">)</span>
        <span class="nv">drawnTreasures = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">drawn</span>
          <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
            <span class="nx">drawnTreasures</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="nv">treasureToTrash = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;trashOppTreasure&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">drawnTreasures</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">treasureToTrash</span>
          <span class="nv">attackSuccess = </span><span class="kc">true</span>
          <span class="nx">transferCard</span><span class="p">(</span><span class="nx">treasureToTrash</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} trashes #{opp.ai}&#39;s #{treasureToTrash}.&quot;</span><span class="p">)</span>
        <span class="nv">opp.discard = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} discards #{drawn}.&quot;</span><span class="p">)</span>
        
      <span class="k">if</span> <span class="nx">attackSuccess</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">mats</span><span class="p">.</span><span class="nx">pirateShip</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} takes a Coin token (#{state.current.mats.pirateShip} on the mat).&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Rabble&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">3</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nv">drawn = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{opp.ai} draws #{drawn}.&quot;</span><span class="p">)</span>

      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">drawn</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span> <span class="o">or</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
          <span class="nx">opp</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...discarding #{card}.&quot;</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">])</span>
        <span class="k">else</span>
          <span class="nx">opp</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">order = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseOrderOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">setAside</span><span class="p">,</span> <span class="nx">opp</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{order} back on the deck.&quot;</span><span class="p">)</span>
        <span class="nv">opp.draw = </span><span class="nx">order</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">opp</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
        <span class="nv">opp.setAside = </span><span class="p">[]</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Saboteur&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">upgradeFilter: </span><span class="nf">(state, oldCard, newCard) -&gt;</span>
    <span class="p">[</span><span class="nx">coins1</span><span class="p">,</span> <span class="nx">potions1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">coins2</span><span class="p">,</span> <span class="nx">potions2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newCard</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">potions1</span> <span class="o">&gt;=</span> <span class="nx">potions2</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">coins1</span><span class="o">-</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="nx">coins2</span><span class="p">)</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nv">drawn = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
        <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span>                      
      <span class="p">)</span>
      <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">cardToTrash = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} trashes #{opp.ai}&#39;s #{cardToTrash}.&quot;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nv">choices = </span><span class="nx">upgradeChoices</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Saboteur</span><span class="p">.</span><span class="nx">upgradeFilter</span><span class="p">)</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">cardToTrash</span><span class="p">,</span><span class="kc">null</span><span class="p">])</span>
        <span class="nv">choice = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
        <span class="nv">newCard = </span><span class="nx">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">newCard</span><span class="o">?</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">newCard</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} gains #{newCard}.&quot;</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} gains nothing.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Scrying Pool&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">spyDecision</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="s1">&#39;scryingPoolDiscard&#39;</span><span class="p">)</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">spyDecision</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">opp</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="s1">&#39;discardFromOpponentDeck&#39;</span><span class="p">)</span>
    
    <span class="nx">loop</span>
      <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">break</span> <span class="k">if</span> <span class="p">(</span><span class="o">not</span> <span class="nx">drawn</span><span class="o">?</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="o">not</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">isAction</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Sea Hag&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">discardFromDeck</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting the Curse on top of the deck.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Spy&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">spyDecision</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">)</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">spyDecision</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">opp</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="s1">&#39;discardFromOpponentDeck&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Thief&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nv">drawn = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} reveals #{drawn}.&quot;</span><span class="p">)</span>
      <span class="nv">drawnTreasures = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">drawn</span>
        <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
          <span class="nx">drawnTreasures</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="nv">treasureToTrash = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;trashOppTreasure&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">drawnTreasures</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">treasureToTrash</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} trashes #{opp.ai}&#39;s #{treasureToTrash}.&quot;</span><span class="p">)</span>
        <span class="nx">transferCard</span><span class="p">(</span><span class="nx">treasureToTrash</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>

        <span class="nv">cardToGain = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseGain</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">treasureToTrash</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
        <span class="k">if</span> <span class="nx">cardToGain</span>
          <span class="nx">transferCard</span><span class="p">(</span><span class="nx">cardToGain</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">handleGainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">cardToGain</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} gains the trashed #{treasureToTrash}.&quot;</span><span class="p">)</span>
      <span class="nv">opp.discard = </span><span class="nx">opp</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="p">[</span><span class="nx">drawn</span><span class="p">])</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{opp.ai} discards #{drawn}.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Torturer&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">3</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="k">if</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;torturer&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;curse&#39;</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;curse&#39;</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">,</span> <span class="s1">&#39;hand&#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Witch&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Young Witch&#39;</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">attackOpponents</span> <span class="nf">(opp) -&gt;</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">bane</span> <span class="k">in</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{opp.ai} is protected by the Bane card, #{state.bane}.&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Curse</span><span class="p">)</span>
    
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h2>Miscellaneous cards</h2>

<p>All of these cards have effects beyond what can be expressed with a
simple formula, which are generally defined by overriding the complex
methods such as <code>playEffect</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Adventurer&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
      <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span><span class="p">,</span>
      <span class="mi">2</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">treasures = </span><span class="nx">drawn</span>
      <span class="nv">state.current.hand = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">treasures</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} draws #{treasures}.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Alchemist&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>

  <span class="nv">cleanupEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Potion</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span>
        <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Alchemist</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Apothecary&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Sort the cards into coppers and potions, which go to the hand,
and others, which go temporarily to the setAside pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...drawing #{drawn}.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">drawn</span>
      <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span> <span class="o">or</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Potion</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{card} in the hand.&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">order = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseOrderOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{order} back on the deck.&quot;</span><span class="p">)</span>
      <span class="nv">state.current.draw = </span><span class="nx">order</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
      <span class="nv">state.current.setAside = </span><span class="p">[]</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Baron&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">buys: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">discardEstate = </span><span class="kc">no</span>
    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
      <span class="nv">discardEstate = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;baronDiscard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="kc">yes</span><span class="p">,</span> <span class="kc">no</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">discardEstate</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="mi">4</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Estate</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Border Village&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Village</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>

  <span class="nv">gainEffect: </span><span class="nf">(state, player) -&gt;</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="p">[</span><span class="nx">myCoins</span><span class="p">,</span> <span class="nx">myPotions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Border Village&#39;</span><span class="p">].</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">].</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">potions</span> <span class="o">&lt;=</span> <span class="nx">myPotions</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;</span> <span class="nx">myCoins</span>
          <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">])</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Bridge&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">buys: </span><span class="mi">1</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">bridges</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Cartographer&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span>
    <span class="nv">revealed = </span><span class="nx">player</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="nv">kept = </span><span class="p">[]</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} reveals #{revealed} from the deck.&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="nx">revealed</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">card = </span><span class="nx">revealed</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} discards #{card}.&quot;</span><span class="p">)</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">])</span>
      <span class="k">else</span>
        <span class="nx">kept</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nv">order = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseOrderOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">kept</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} puts #{order} back on the deck.&quot;</span><span class="p">)</span>
    <span class="nv">player.draw = </span><span class="nx">order</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Cellar&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">actions: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">startingCards = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">allowDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="kc">Infinity</span><span class="p">)</span>
    <span class="nv">numDiscarded = </span><span class="nx">startingCards</span> <span class="o">-</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">numDiscarded</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Chancellor&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>The AI has the option of reshuffling. Ask directly if it'll take it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;reshuffle&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="kc">yes</span><span class="p">,</span> <span class="kc">no</span><span class="p">])</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting the draw pile into the discard pile.&quot;</span><span class="p">)</span>
      <span class="nv">draw = </span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nv">player.draw = </span><span class="p">[]</span>
      <span class="nv">player.discard = </span><span class="nx">player</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">draw</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">draw</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Chapel&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">allowTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  
  <span class="nv">getCards: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">numEmptyPiles</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span>
      <span class="mi">2</span>
    <span class="k">else</span>
      <span class="mi">1</span>
  
  <span class="nv">getBuys: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">numEmptyPiles</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span>
      <span class="mi">1</span>
    <span class="k">else</span>
      <span class="mi">0</span>
  
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">numEmptyPiles</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span>
      <span class="mi">1</span>
    <span class="k">else</span>
      <span class="mi">0</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Conspirator&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>don't count Duration cards because they're not "played this turn"</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getActions: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actionsPlayed</span> <span class="o">&gt;=</span> <span class="mi">3</span>
      <span class="mi">1</span>
    <span class="k">else</span>
      <span class="mi">0</span>
  <span class="nv">getCards: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actionsPlayed</span> <span class="o">&gt;=</span> <span class="mi">3</span>
      <span class="mi">1</span>
    <span class="k">else</span>
      <span class="mi">0</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Coppersmith&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">copperValue</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Council Room&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="mi">4</span>
  <span class="nv">buys: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">for</span> <span class="nx">opp</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Counting House&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">coppersFromDiscard = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span> <span class="k">when</span> <span class="nx">card</span><span class="o">==</span><span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
    <span class="nv">state.current.discard = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span> <span class="k">when</span> <span class="nx">card</span><span class="o">!=</span><span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
    <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">coppersFromDiscard</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} puts &quot;</span> <span class="o">+</span> <span class="nx">coppersFromDiscard</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; Coppers into his hand.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Courtyard&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">cards: </span><span class="mi">3</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;putOnDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doPutOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">card</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Crossroads&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">crossroadsPlayed</span>
      <span class="nv">state.current.crossroadsPlayed = </span><span class="kc">true</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">+=</span> <span class="mi">3</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>shortcut, because it doesn't particularly matter whether just the
victory cards are revealed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">state</span><span class="p">.</span><span class="nx">revealHand</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>

    <span class="nv">nVictory = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span> <span class="k">when</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span><span class="p">).</span><span class="nx">length</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">nVictory</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Duchess&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">for</span> <span class="nx">pl</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span>
      <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">pl</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{pl.ai} reveals #{drawn}.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">drawn</span><span class="o">?</span>
        <span class="nv">discarded = </span><span class="nx">pl</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">drawn</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
        <span class="k">if</span> <span class="nx">discarded</span><span class="o">?</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...choosing to discard it.&quot;</span><span class="p">)</span>
          <span class="nx">pl</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...choosing to put it back.&quot;</span><span class="p">)</span>
          <span class="nx">pl</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Embassy&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">5</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
  <span class="nv">gainEffect: </span><span class="nf">(state, player) -&gt;</span>
    <span class="k">for</span> <span class="nx">pl</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span>
      <span class="k">if</span> <span class="nx">pl</span> <span class="o">isnt</span> <span class="nx">player</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">pl</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Envoy&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} draws #{drawn}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Have the left-hand neighbor (or the AI itself in solitaire) choose a card
to discard.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">neighbor = </span><span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">choice = </span><span class="nx">neighbor</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discardForEnvoy&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{neighbor.ai} chooses for #{state.current.ai} to discard #{choice}.&quot;</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">choice</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">)</span>
      <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">drawn</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Explorer&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">cardToGain = </span><span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span>

    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Province</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;…revealing a Province.&quot;</span><span class="p">)</span>
      <span class="nv">cardToGain = </span><span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span>

    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">countInSupply</span><span class="p">(</span><span class="nx">cardToGain</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">cardToGain</span><span class="p">,</span> <span class="s1">&#39;hand&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;…and gaining a #{cardToGain}, putting it in the hand.&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;…but there are no #{cardToGain}s available to gain.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Farming Village&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
      <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span> <span class="o">or</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} draws #{card}.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Feast&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Trash the Feast, unless it's already been trashed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">playLocation</span> <span class="o">!=</span> <span class="s1">&#39;trash&#39;</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Feast</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">playLocation</span><span class="p">],</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
      <span class="nv">state.current.playLocation = </span><span class="s1">&#39;trash&#39;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...trashing the Feast.&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Gain a card costing up to $5.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">cardName</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">potions</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;=</span> <span class="mi">5</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Golem&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
      <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span> <span class="o">and</span> <span class="nx">card</span><span class="p">.</span><span class="nx">name</span> <span class="o">isnt</span> <span class="s1">&#39;Golem&#39;</span><span class="p">,</span>
      <span class="mi">2</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">firstAction = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">)</span>
      <span class="nx">drawn</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">firstAction</span><span class="p">)</span>
      <span class="nv">secondAction = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">actions = </span><span class="p">[</span><span class="nx">firstAction</span><span class="p">,</span> <span class="nx">secondAction</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">actions</span>
        <span class="k">if</span> <span class="nx">card</span><span class="o">?</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} plays #{card}.&quot;</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
          <span class="nv">state.current.playLocation = </span><span class="s1">&#39;inPlay&#39;</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">resolveAction</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Grand Market&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Market</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">6</span>
  <span class="nv">coins: </span><span class="mi">2</span>
  <span class="nv">actions: </span><span class="mi">1</span>
  <span class="nv">cards: </span><span class="mi">1</span>
  <span class="nv">buys: </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Grand Market is the only card with a non-constant mayBeBought value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mayBeBought: </span><span class="nf">(state) -&gt;</span>
    <span class="o">not</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Haggler&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>  
  <span class="nv">buyInPlayEffect: </span><span class="nf">(state, card1) -&gt;</span>
    <span class="p">[</span><span class="nx">coins1</span><span class="p">,</span> <span class="nx">potions1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card1</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">cardName</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
      <span class="nv">card2 = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">coins2</span><span class="p">,</span> <span class="nx">potions2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card2</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">potions2</span> <span class="o">&lt;=</span> <span class="nx">potions1</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">coins2</span> <span class="o">&lt;</span> <span class="nx">coins1</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">card2</span><span class="p">.</span><span class="nx">isVictory</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card2</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">potions2</span> <span class="o">&lt;</span> <span class="nx">potions1</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">coins2</span> <span class="o">==</span> <span class="nx">coins1</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">card2</span><span class="p">.</span><span class="nx">isVictory</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card2</span><span class="p">)</span>        
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Hamlet&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>We take a bit of a shortcut for now: we discard up to two cards, then if only
one was discarded, decide whether to use it for +action or +buy.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">discarded = </span><span class="nx">state</span><span class="p">.</span><span class="nx">allowDiscard</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} gets +1 action and +1 buy.&quot;</span><span class="p">)</span>
      <span class="nx">player</span><span class="p">.</span><span class="nx">actions</span><span class="o">++</span>
      <span class="nx">player</span><span class="p">.</span><span class="nx">buys</span><span class="o">++</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="nv">benefit = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;benefit&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">{</span><span class="nv">actions: </span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">cards: </span><span class="mi">1</span><span class="p">}</span>
      <span class="p">])</span>
      <span class="nx">applyBenefit</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Harvest&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">unique = </span><span class="p">[]</span>
    <span class="nv">cards = </span><span class="nx">state</span><span class="p">.</span><span class="nx">discardFromDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">cards</span>
      <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">unique</span>
        <span class="nx">unique</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="nx">unique</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...gaining +$#{unique.length}.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Herbalist&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">buys: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">cleanupEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;herbalist&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} uses Herbalist to put #{choice} back on the deck.&quot;</span><span class="p">)</span>
      <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">choice</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
      
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Highway&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">highways = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s2">&quot;Highway&quot;</span>
        <span class="nx">highways</span><span class="o">++</span>
    <span class="nv">state.highways = </span><span class="nx">highways</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Horse Traders&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">buys: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">3</span>
  <span class="nv">isReaction: </span><span class="kc">true</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Horse Traders is not actually a duration card, but it resolves like one
when it is set aside. There seems to be no harm in simplifying by
putting it in the duration area.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">durationEffect:</span>
    <span class="nf">(state) -&gt;</span> </pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Pick up Horse Traders and draw another card.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Horse Traders&#39;</span><span class="p">],</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">duration</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  
  <span class="nv">reactToAttack:</span>
    <span class="nf">(state, player) -&gt;</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Horse Traders&#39;</span><span class="p">],</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">player</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>So far Hunting Party is the only card that digs for something 
dependent on the game state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Hunting Party&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">revealHand</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>    
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">dig</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span>
      <span class="nf">(state, card) -&gt;</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...#{state.current.ai} draws #{card}.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Ironworks&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">cardName</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">potions</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;=</span> <span class="mi">4</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nv">gained = </span><span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nx">gained</span><span class="p">.</span><span class="nx">isAction</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">gained</span><span class="p">.</span><span class="nx">isTreasure</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">gained</span><span class="p">.</span><span class="nx">isVictory</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Jack of All Trades is a complex card made up of steps that are simple
to code:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">makeCard</span> <span class="s1">&#39;Jack of All Trades&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Gain a silver.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Look at the top card of your deck...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">card = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>discard it or put it back.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">card</span><span class="o">?</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} reveals and discards #{card}.&quot;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} reveals #{card} and puts it back.&quot;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Draw until you have 5 cards in hand.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">5</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">5</span> <span class="o">-</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>You may trash a card from your hand that is not a Treasure.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">choices = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span><span class="p">)</span>
    <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;trash&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span>

<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;King&#39;s Court&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">7</span>
  <span class="nv">isMultiplier: </span><span class="kc">true</span>
  <span class="nv">multiplier: </span><span class="mi">3</span>
  <span class="nv">optional: </span><span class="kc">true</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span> <span class="k">when</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choices</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...but has no action to play with the #{this}.&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@optional</span>
      <span class="nv">action = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;multipliedAction&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="kc">null</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...choosing not to play an action.&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">transferCard</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">)</span>

        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@multiplier</span><span class="p">]</span>
          <span class="k">return</span> <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="kc">null</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...playing #{action} (#{i+1} of #{@multiplier}).&quot;</span><span class="p">)</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">resolveAction</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
        </pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Determine whether this multiplier is going to go to the duration area
during the cleanup phase.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">putInDuration = </span><span class="kc">false</span>
        <span class="nv">neverPutInDuration = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>If we've already marked a multiplier to be put in the Duration area,
don't mark this one. It's either already marked or it's not needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">md = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">multipliedDurations</span>
        <span class="k">if</span> <span class="nx">md</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">md</span><span class="p">[</span><span class="nx">md</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">isMultiplier</span>
          <span class="nv">neverPutInDuration = </span><span class="kc">true</span>

        <span class="nx">unless</span> <span class="nx">neverPutInDuration</span>
          <span class="k">if</span> <span class="nx">action</span><span class="p">.</span><span class="nx">isMultiplier</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Mark the multiplier as if it were a multiplied Duration, which is
a flag to not clean it up (as if it were a Duration) later.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">md</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="nx">md</span><span class="p">[</span><span class="nx">md</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">isMultiplier</span><span class="p">)</span>
              <span class="nv">putInDuration = </span><span class="kc">true</span>
          <span class="k">if</span> <span class="nx">action</span><span class="p">.</span><span class="nx">isDuration</span> <span class="o">and</span> <span class="nx">action</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s1">&#39;Tactician&#39;</span>
            <span class="nv">putInDuration = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Store virtual copies of a multiplied duration card in <code>multipliedDurations</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@multiplier</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
              <span class="nx">md</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nx">putInDuration</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Mark it by putting it in multipliedDurations. This also signals that
all multiplied duration cards previous to it are accounted for.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">md</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

  <span class="nv">durationEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>TR and KC don't actually have a duration effect. The multiplication of
of the Duration card has already happened, possibly more than once, and
the number of times it happens is not strictly related to the number of
multipliers in the duration area. It took a very long BGG thread to
figure this out.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Library&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span>
    <span class="k">while</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">7</span>
      <span class="nv">drawn = </span><span class="nx">player</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>If nothing was drawn, the deck and discard pile are empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...stopping because there are no cards to draw.&quot;</span><span class="p">)</span>
        <span class="k">break</span>

      <span class="nv">card = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Assume the times the AI wants to set the card aside are the times it
is on the discard priority list or has a positive discard value.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} sets aside a #{card}.&quot;</span><span class="p">)</span>
          <span class="nx">player</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} draws a #{card} and chooses to keep it.&quot;</span><span class="p">)</span>
          <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} draws a #{card}.&quot;</span><span class="p">)</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Discard the set-aside cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">discards = </span><span class="nx">player</span><span class="p">.</span><span class="nx">setAside</span>
    <span class="nv">player.discard = </span><span class="nx">player</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">discards</span><span class="p">)</span>
    <span class="nv">player.setAside = </span><span class="p">[]</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">discards</span><span class="p">)</span>

<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Lookout&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...drawing #{drawn}.&quot;</span><span class="p">)</span>
    <span class="nv">state.current.setAside = </span><span class="nx">drawn</span>
    <span class="nv">trash = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;trash&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">trash</span> <span class="o">isnt</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Trash the card, with the side effect of removing it from the choice
list.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...trashing #{trash}.&quot;</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">trash</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
    
    <span class="nv">discard = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">discard</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">discard</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...discarding #{discard}.&quot;</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="p">[</span><span class="nx">discard</span><span class="p">])</span>
    </pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Put the remaining card back on the deck.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{drawn} back on the deck.&quot;</span><span class="p">)</span>
    <span class="nv">state.current.draw = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
    <span class="nv">state.current.setAside = </span><span class="p">[]</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Mandarin&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">3</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">putBack = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;putOnDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doPutOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">putBack</span><span class="p">)</span>
  
  <span class="nv">gainEffect: </span><span class="nf">(state, player) -&gt;</span>
    <span class="nv">treasures = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">player</span><span class="p">.</span><span class="nx">inPlay</span> <span class="k">when</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">treasures</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="nx">treasure</span> <span class="k">in</span> <span class="nx">treasures</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">treasure</span><span class="p">)</span>
      <span class="nv">order = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseOrderOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">treasures</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{order} back on the deck.&quot;</span><span class="p">)</span>
      <span class="nv">player.draw = </span><span class="nx">order</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Masquerade&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Get everyone's choice of cards to pass.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">passed = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">player</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span>
      <span class="nv">cardToPass = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;trash&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
      <span class="nx">passed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cardToPass</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Pass the cards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">state</span><span class="p">.</span><span class="nx">nPlayers</span><span class="p">]</span>
      <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nv">nextPlayer = </span><span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nx">state</span><span class="p">.</span><span class="nx">nPlayers</span><span class="p">]</span>
      <span class="nv">cardToPass = </span><span class="nx">passed</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} passes #{cardToPass}.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">cardToPass</span> <span class="o">isnt</span> <span class="kc">null</span>
        <span class="nx">transferCard</span><span class="p">(</span><span class="nx">cardToPass</span><span class="p">,</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">nextPlayer</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Allow the Masquerade player to trash a card.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">state</span><span class="p">.</span><span class="nx">allowTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Menagerie&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">revealHand</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">menagerieDraws</span><span class="p">())</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Mint&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">buyEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">state.quarries = </span><span class="mi">0</span>
    <span class="nv">state.potions = </span><span class="mi">0</span>
    <span class="nv">inPlay = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">inPlay</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">inPlay</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isTreasure</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...trashing a #{inPlay[i]}.&quot;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">inPlay</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="nx">inPlay</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">treasures = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nx">treasures</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;mint&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">treasures</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Moat&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">isReaction: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Revealing Moat sets a flag in the player's state, indicating
that the player is unaffected by the attack. In this code, Moat
is always revealed, without an AI decision.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reactToAttack:</span>
    <span class="nf">(state, player) -&gt;</span> <span class="nv">player.moatProtected = </span><span class="kc">true</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Moneylender&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Copper</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Monument&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="mi">2</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">chips</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Nomad Camp&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Woodcutter</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>

  <span class="nv">gainEffect: </span><span class="nf">(state, player) -&gt;</span>
    <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">gainLocation</span> <span class="o">!=</span> <span class="s1">&#39;trash&#39;</span>
      <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Nomad Camp&#39;</span><span class="p">],</span> <span class="nx">player</span><span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">gainLocation</span><span class="p">],</span> <span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
      <span class="nv">player.gainLocation = </span><span class="s1">&#39;draw&#39;</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting the Nomad Camp on top of the deck.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Navigator&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discardHand&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">drawn</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span> <span class="o">is</span> <span class="kc">null</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...choosing to keep #{drawn}.&quot;</span><span class="p">)</span>
      <span class="nv">order = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseOrderOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{order} back on the deck.&quot;</span><span class="p">)</span>
      <span class="nv">state.current.draw = </span><span class="nx">order</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...discarding #{drawn}.&quot;</span><span class="p">)</span>
      <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">,</span> <span class="nx">drawn</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">drawn</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Oasis&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">coins: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Pawn&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nv">benefit = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;benefit&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">{</span><span class="nv">cards: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">cards: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">buys: </span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">cards: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">actions: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">buys: </span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">actions: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">buys: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">coins: </span><span class="mi">1</span><span class="p">}</span>
      <span class="p">])</span>
      <span class="nx">applyBenefit</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Pearl Diver&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span>
    <span class="nv">bottomCard = </span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">bottomCard</span><span class="o">?</span>
      <span class="nv">doNotWant = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">bottomCard</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
      <span class="k">if</span> <span class="nx">doNotWant</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...choosing to leave #{bottomCard} at the bottom of the deck.&quot;</span><span class="p">)</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">bottomCard</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...moving #{bottomCard} from the bottom to the top of the deck.&quot;</span><span class="p">)</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">bottomCard</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...but the draw pile is empty.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Peddler&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">8</span>
  <span class="nv">actions: </span><span class="mi">1</span>
  <span class="nv">cards: </span><span class="mi">1</span>
  <span class="nv">coins: </span><span class="mi">1</span>
  <span class="nv">costInCoins: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">cost = </span><span class="mi">8</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">phase</span> <span class="o">is</span> <span class="s1">&#39;buy&#39;</span>
      <span class="nx">cost</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actionsPlayed</span>
      <span class="k">if</span> <span class="nx">cost</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="nv">cost = </span><span class="mi">0</span>
    <span class="nx">cost</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Scout&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...drawing #{drawn}.&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Implemented approximately the same way as Apothecary.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">drawn</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{card} in the hand.&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">order = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseOrderOnDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setAside</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting #{order} back on the deck.&quot;</span><span class="p">)</span>
      <span class="nv">state.current.draw = </span><span class="nx">order</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
      <span class="nv">state.current.setAside = </span><span class="p">[]</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Shanty Town&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">revealHand</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">shantyTownDraws</span><span class="p">())</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Smugglers&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">smugglerChoices</span><span class="p">())</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Spice Merchant&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">trashChoices = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span> <span class="k">when</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span><span class="p">)</span>
    <span class="nx">trashChoices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="nv">trashed = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;spiceMerchantTrash&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">trashChoices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">trashed</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">trashed</span><span class="p">)</span>
      <span class="nv">benefit = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;benefit&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">{</span><span class="nv">cards: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">actions: </span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">coins: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">buys: </span><span class="mi">1</span><span class="p">}</span>
      <span class="p">])</span>
      <span class="nx">applyBenefit</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Stables&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">discardChoices = </span><span class="p">(</span><span class="nx">card</span> <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span> <span class="k">when</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span><span class="p">)</span>
    <span class="nx">discardChoices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="nv">discarded = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;stablesDiscard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">discardChoices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">discarded</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">discarded</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Steward&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span>
      <span class="nv">benefit = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;benefit&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">{</span><span class="nv">cards: </span><span class="mi">2</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">coins: </span><span class="mi">2</span><span class="p">},</span>
        <span class="p">{</span><span class="nv">trash: </span><span class="mi">2</span><span class="p">}</span>
      <span class="p">])</span>
      <span class="nx">applyBenefit</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Throne Room&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">[</span><span class="s2">&quot;King&#39;s Court&quot;</span><span class="p">],</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">multiplier: </span><span class="mi">2</span>
  <span class="nv">optional: </span><span class="kc">false</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Tournament&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">playEffect:</span>
    <span class="nf">(state) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>All Provinces are automatically revealed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">opposingProvince = </span><span class="kc">false</span>
      <span class="k">for</span> <span class="nx">opp</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Province</span> <span class="k">in</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">hand</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{opp.ai} reveals a Province.&quot;</span><span class="p">)</span>
          <span class="nv">opposingProvince = </span><span class="kc">true</span>
      <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Province</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
        <span class="nv">discardProvince = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;tournamentDiscard&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="kc">yes</span><span class="p">,</span> <span class="kc">no</span><span class="p">])</span>
        <span class="k">if</span> <span class="nx">discardProvince</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">doDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Province</span><span class="p">)</span>
          <span class="nv">choices = </span><span class="nx">state</span><span class="p">.</span><span class="nx">prizes</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Duchy</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Duchy</span><span class="p">)</span>
          <span class="nv">choice = </span><span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choices</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">choice</span> <span class="o">isnt</span> <span class="kc">null</span>
            <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...putting the #{choice} on top of the deck.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">opposingProvince</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Trade Route&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">buys: </span><span class="mi">1</span>
  <span class="nv">trash: </span><span class="mi">1</span>
  <span class="nv">getCoins: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">tradeRouteValue</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Trader&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">trashed = </span><span class="nx">state</span><span class="p">.</span><span class="nx">requireTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">trashed</span><span class="o">?</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">coins</span><span class="p">]</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p><code>reactReplacingGain</code> triggers before <code>reactToGain</code>, and lets you replace
the card with a different one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reactReplacingGain: </span><span class="nf">(state, player, card) -&gt;</span>
    <span class="nv">card = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="nx">card</span><span class="p">])</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">[</span><span class="nx">card</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Trading Post&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">requireTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">,</span> <span class="s1">&#39;hand&#39;</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...gaining a Silver in hand.&quot;</span><span class="p">)</span>    
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s2">&quot;Transmute&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">0</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">player = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span>
    <span class="nv">trashed = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;transmute&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">player</span><span class="p">.</span><span class="nx">hand</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">trashed</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">trashed</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Duchy</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Transmute</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">trashed</span><span class="p">.</span><span class="nx">isVictory</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Treasure Map&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">trashedMaps = </span><span class="mi">0</span>

    <span class="k">if</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Treasure Map&#39;</span><span class="p">]</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...trashing the Treasure Map.&quot;</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Treasure Map&#39;</span><span class="p">],</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">inPlay</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
      <span class="nx">trashedMaps</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Treasure Map&#39;</span><span class="p">]</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">doTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;Treasure Map&#39;</span><span class="p">])</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...and trashing another Treasure Map.&quot;</span><span class="p">)</span>
      <span class="nx">trashedMaps</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nx">trashedMaps</span> <span class="o">==</span> <span class="mi">2</span>
      <span class="nv">numGolds = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">num</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">countInSupply</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Gold</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">)</span>
          <span class="nx">numGolds</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;…gaining #{numGolds} Golds, putting them on top of the deck.&quot;</span><span class="p">)</span>      
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Treasury&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Market</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">buys: </span><span class="mi">0</span>
  
  <span class="nv">buyInPlayEffect: </span><span class="nf">(state, card) -&gt;</span>
    <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span>
      <span class="nv">state.current.mayReturnTreasury = </span><span class="kc">no</span>
      
  <span class="nv">cleanupEffect: </span><span class="nf">(state) -&gt;</span>    
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">mayReturnTreasury</span>
      <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Treasury</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} returns a Treasury to the top of the deck.&quot;</span><span class="p">)</span>    
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Tribute&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">revealedCards = </span><span class="nx">state</span><span class="p">.</span><span class="nx">discardFromDeck</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nv">unique = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">revealedCards</span>
      <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">unique</span>
        <span class="nx">unique</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">unique</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">+=</span> <span class="mi">2</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isTreasure</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="mi">2</span>
      <span class="k">if</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isVictory</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;University&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">2</span>
  <span class="nv">costPotion: </span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="mi">2</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">cardName</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">potions</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="o">and</span> <span class="nx">card</span><span class="p">.</span><span class="nx">isAction</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Vault&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">5</span>
  <span class="nv">cards: </span><span class="o">+</span><span class="mi">2</span>

  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">discarded = </span><span class="nx">state</span><span class="p">.</span><span class="nx">allowDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="kc">Infinity</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...getting +$#{discarded.length} from the Vault.&quot;</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span>

    <span class="k">for</span> <span class="nx">opp</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
      <span class="k">if</span> <span class="nx">opp</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">wantsToDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="nv">discarded = </span><span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">discarded</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">opp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Walled Village&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Village</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">4</span>
  </pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Clean up effect defined in <code>State.doCleanupPhase</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Warehouse&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">actions: </span><span class="o">+</span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">requireDiscard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Watchtower&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">isReaction: </span><span class="kc">true</span>
  
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">handLength = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">handLength</span> <span class="o">&lt;</span> <span class="mi">6</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="mi">6</span> <span class="o">-</span> <span class="nx">handLength</span><span class="p">)</span>
  
  <span class="nv">reactToGain: </span><span class="nf">(state, player, card) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">gainLocation</span> <span class="o">==</span> <span class="s1">&#39;trash&#39;</span>
    <span class="nv">source = </span><span class="nx">player</span><span class="p">[</span><span class="nx">player</span><span class="p">.</span><span class="nx">gainLocation</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Determine if the player wants to trash the card. If so, use the
Watchtower to do so.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">chooseTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span> <span class="o">is</span> <span class="nx">card</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>trash the card</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} reveals a Watchtower and trashes the #{card}.&quot;</span><span class="p">)</span>
      <span class="nx">transferCard</span><span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Note that the gained card now has no valid location; it's in the trash.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">player.gainLocation = </span><span class="s1">&#39;trash&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;gainOnDeck&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} reveals a Watchtower and puts the #{card} on the deck.&quot;</span><span class="p">)</span>
      <span class="nv">player.gainLocation = </span><span class="s1">&#39;draw&#39;</span>
      <span class="nx">transferCardToTop</span><span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Wishing Well&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">cards: </span><span class="mi">1</span>
  <span class="nv">actions: </span><span class="mi">1</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">cardName</span> <span class="k">in</span> <span class="nx">c</span><span class="p">.</span><span class="nx">allCards</span>
      <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">])</span>
      
    <span class="nv">wish = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s1">&#39;wish&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...wishing for a #{wish}.&quot;</span><span class="p">)</span>
    <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">drawn</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">drawn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">card</span> <span class="o">is</span> <span class="nx">wish</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...revealing a #{card} and keeping it.&quot;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...revealing a #{card} and putting it back.&quot;</span><span class="p">)</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...drawing nothing.&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">makeCard</span> <span class="s1">&#39;Workshop&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">cost: </span><span class="mi">3</span>
  <span class="nv">playEffect: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">choices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">cardName</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardName</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">potions</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">coins</span> <span class="o">&lt;=</span> <span class="mi">4</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">gainOneOf</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <h2>Utility functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p><code>transferCard</code> will move a card from one list to the end of another.</p>

<p>If you are doing something to each card in a list which might result in
that card being moved somewhere else, you <em>must</em> iterate over the list
backwards. Otherwise you'll run off the end of the list.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">transferCard = </span><span class="nf">(card, fromList, toList) -&gt;</span>
  <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">fromList</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;#{fromList} does not contain #{card}&quot;</span><span class="p">)</span>
  <span class="nx">fromList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
  <span class="nx">toList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p><code>transferCardToTop</code> will move a card from one list to the front of another.
This is used to put a card on top of the deck, for example.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">transferCardToTop = </span><span class="nf">(card, fromList, toList) -&gt;</span>
  <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">fromList</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;#{fromList} does not contain #{card}&quot;</span><span class="p">)</span>
  <span class="nx">fromList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
  <span class="nx">toList</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Some cards give you a constant benefit, such as +cards or +actions,
every time you play them; these benefits are defined directly on the card
object. Other cards give you such a benefit only under certain conditions,
and if the benefits are straightforward, we may use <code>applyBenefit</code> to make
them happen. This takes in an object that describes the benefit, and
applies it to the game state.</p>

<p>The actions that can be performed through <code>applyBenefit</code> currently are:</p>

<ul>
<li><code>{cards: n}</code>: draw <em>n</em> cards</li>
<li><code>{actions: n}</code>: get <em>+n</em> actions</li>
<li><code>{buys: n}</code>: get <em>+n</em> buys</li>
<li><code>{coins: n}</code>: get <em>+n</em> coins</li>
<li><code>{trash: n}</code>: trash <em>n</em> cards</li>
<li><code>{horseEffect: yes}</code>: gain 4 Silvers and discard your draw pile</li>
</ul>

<p>The AI has no rule in it that chooses <code>horseEffect</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">applyBenefit = </span><span class="nf">(state, benefit) -&gt;</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{state.current.ai} gets #{JSON.stringify(benefit)}.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">cards</span><span class="o">?</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">drawCards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">cards</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">actions</span><span class="o">?</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">actions</span> <span class="o">+=</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">actions</span>
  <span class="k">if</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">buys</span><span class="o">?</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">buys</span> <span class="o">+=</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">buys</span>
  <span class="k">if</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">coins</span><span class="o">?</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">coins</span> <span class="o">+=</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">coins</span>
  <span class="k">if</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">trash</span><span class="o">?</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">requireTrash</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">trash</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">benefit</span><span class="p">.</span><span class="nx">horseEffect</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="mi">4</span><span class="p">]</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">gainCard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Silver</span><span class="p">)</span>
    <span class="nv">discards = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">draw</span>
    <span class="nv">state.current.discard = </span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">discards</span><span class="p">)</span>
    <span class="nv">state.current.draw = </span><span class="p">[]</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">handleDiscards</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">discards</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p><code>upgradeChoices</code> is a helper function to get a list of choices for
Remodel and similar "upgrading" cards. In addition to the game state, it
takes in:</p>

<ul>
<li><code>cards</code>: a list of cards that may be improved, which is usually the cards
in hand; duplicates are fine.</li>
<li><code>filter</code>: a function of (oldCard, newCard) that describes whether the
improvement is allowed.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">upgradeChoices = </span><span class="nf">(state, cards, filter) -&gt;</span>
  <span class="nv">used = </span><span class="p">[]</span>
  <span class="nv">choices = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">cards</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">used</span>
      <span class="nx">used</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">cardname2</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
        <span class="nv">card2 = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardname2</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">card</span><span class="p">,</span> <span class="nx">card2</span><span class="p">)</span> <span class="o">and</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="nx">card2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">card</span><span class="p">,</span> <span class="nx">card2</span><span class="p">])</span>          
  <span class="k">return</span> <span class="nx">choices</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Find options where you can upgrade a card into nothing, because you're
required to gain a card at a cost where there isn't anything.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">nullUpgradeChoices = </span><span class="nf">(state, cards, costFunction) -&gt;</span>
  <span class="nv">costs = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">cardname</span> <span class="k">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span>
    <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">supply</span><span class="p">[</span><span class="nx">cardname</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">card = </span><span class="nx">c</span><span class="p">[</span><span class="nx">cardname</span><span class="p">]</span>
      <span class="nv">cost = </span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>  <span class="c1"># make it a string so it&#39;s searchable</span>
      <span class="k">if</span> <span class="nx">cost</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">costs</span>
        <span class="nx">costs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cost</span><span class="p">)</span>

  <span class="nv">used = </span><span class="p">[]</span>
  <span class="nv">choices = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">card</span> <span class="k">in</span> <span class="nx">cards</span>
    <span class="k">if</span> <span class="nx">card</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">used</span>
      <span class="nx">used</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">card</span><span class="p">)</span>
      <span class="p">[</span><span class="nx">coins</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">getCost</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="nv">coins2 = </span><span class="nx">costFunction</span><span class="p">(</span><span class="nx">coins</span><span class="p">)</span>
      <span class="nv">costStr = </span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="p">[</span><span class="nx">coins2</span><span class="p">,</span> <span class="nx">potions</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">costStr</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">costs</span>
        <span class="nx">choices</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">card</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
  <span class="k">return</span> <span class="nx">choices</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>The <code>player</code> makes a single spying decision on <code>target</code>'s deck, using
the decision named <code>decision</code> to decide whether to keep the card. For
example, if the player is choosing to discard from its own deck, the
decision name is <code>discard</code>; if it's an opponent's deck, the decision
name is <code>discardFromOpponentDeck</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">spyDecision = </span><span class="nf">(player, target, state, decision) -&gt;</span>
  <span class="nv">drawn = </span><span class="nx">state</span><span class="p">.</span><span class="nx">getCardsFromDeck</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{target.ai} reveals #{drawn}.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">drawn</span><span class="o">?</span>
    <span class="nv">discarded = </span><span class="nx">player</span><span class="p">.</span><span class="nx">ai</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">decision</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">drawn</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">discarded</span><span class="o">?</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} chooses to discard it.&quot;</span><span class="p">)</span>
      <span class="nx">target</span><span class="p">.</span><span class="nx">discard</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#{player.ai} chooses to put it back on the draw pile.&quot;</span><span class="p">)</span>
      <span class="nx">target</span><span class="p">.</span><span class="nx">draw</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">drawn</span><span class="p">)</span> </pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Export functions that are needed elsewhere.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nv">transferCard = </span><span class="nx">transferCard</span>
<span class="k">this</span><span class="p">.</span><span class="nv">transferCardToTop = </span><span class="nx">transferCardToTop</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 